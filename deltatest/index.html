<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fortiview Holdings — PragOptics™ System Integration</title>
  <meta name="description" content="PragOptics™ is our framework for unifying your business systems into a single, transparent architecture. We connect your data, workflows, and customer touchpoints into dashboards that drive clarity and accountability.">
  <meta name="color-scheme" content="dark light" />
  <!-- Canonical -->
  <link rel="canonical" href="https://fortiviewholdings.com/integration/">
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Fortiview Holdings">
  <meta property="og:title" content="Fortiview Holdings — PragOptics™ System Integration">
  <meta property="og:description" content="Secure, branded backend solutions that empower small businesses with clarity, trust, and scalability.">
  <meta property="og:image" content="https://fortiviewholdings.com/images/social-preview.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://fortiviewholdings.com/integration/">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://fortiviewholdings.com/images/social-preview.png">
  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.webmanifest">
  <!-- Preload brand background -->
  <link rel="preload" as="image" href="https://fortiviewholdings.com/images/bg.png">
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"Fortiview Holdings",
    "url":"https://fortiviewholdings.com",
    "logo":"https://fortiviewholdings.com/images/logo.png",
    "image":"https://fortiviewholdings.com/images/social-preview.png",
    "sameAs":[
      "https://www.linkedin.com/company/fortiviewholdings",
      "https://www.instagram.com/fortiviewholdings"
    ]
  }
  </script>
  <style>
    :root{
      --bg-deep:#000000cc;
      --bg-accent:#101625cc;
      --glass:#d9d9d912;
      --glass-2:#00000012;
      --glass-blur:#000000d0;
      --border:#ffffff1a;
      --ink:#e7ecff;
      --muted:#c6d0f0a6;
      --brand:#1ca490da;
      --brand-600:#21bca5;
      --aura:0 4px 8px rgba(17, 76, 67, 0.678);
      --radius:16px;
      --radius-sm:12px;
      --maxw:1200px;
      --grad:linear-gradient(135deg,#121b2d 0%,#060e1e 40%,#0f1824 100%);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-deep); color:var(--ink);
      scroll-behavior:smooth;
      -webkit-text-size-adjust:100%;
    }
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    .bg{
      position:fixed; inset:0; z-index:-2;
      background: var(--glass);
      filter:blur(6px) brightness(.9) saturate(1.05);
      transform:scale(1.03);
    }
    .bg::after{
      content:""; position:absolute; inset:0;
      background: var(--glass);
    }
    #bg-stars{
      position:fixed; inset:0; width:100vw; height:100vh; z-index:-1; pointer-events:none;
    }
    /* Screen-reader only helper */
    .sr-only {
      position:absolute !important;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }

    /* ===== Global full-screen shimmer overlay (hidden by default) ===== */
    .loader-shimmer{
      position:fixed; inset:0; z-index:9999;
      pointer-events:auto; /* block clicks while loading */
      opacity:0; visibility:hidden;
      transition:opacity 160ms ease, visibility 0s linear 160ms;
      /* subtle dim + shimmer sweep (keeps content visible underneath) */
      background-color:rgba(0,0,0,0.06);
      background-image:linear-gradient(
        90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.18) 40%,
        rgba(255,255,255,0.45) 50%,
        rgba(255,255,255,0.18) 60%,
        rgba(255,255,255,0) 100%
      );
      background-size:200% 100%;
      will-change:opacity, background-position;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    html.is-loading .loader-shimmer{
      opacity:1; visibility:visible;
      transition:opacity 160ms ease;
      animation:shimmer-sweep 1.25s linear infinite;
    }
    @keyframes shimmer-sweep{
      0%{ background-position:-200% 0; }
      100%{ background-position:200% 0; }
    }
    /* Freeze page scroll (optional) */
    html.is-loading{ overflow:hidden; }
    /* Respect reduced-motion */
    @media (prefers-reduced-motion: reduce){
      html.is-loading .loader-shimmer{ animation:none; }
    }
    /* Keep iOS from zooming inputs on focus */
    input, select, textarea { font-size:16px; }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(10px);
      background:var(--glass);
      border-bottom:1px solid var(--border);
    }
    .nav{
      max-width:var(--maxw); margin:0 auto; padding:14px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{display:flex; align-items:center; gap:10px; letter-spacing:.4px; flex-wrap: wrap;}
    .site-label { color: var(--muted); font-size: .95rem; white-space: nowrap;}
    .logo{
      width:34px; height:34px; border-radius:10px;
      background-image:url('https://fortiviewholdings.com/images/Logo.png');
      background-size:cover; background-position:center;
      box-shadow:0 0 0 2px rgba(92,140,69,.25), 0 10px 20px rgba(92,140,69,.18);
    }
    .brand strong{font-weight:800}
    nav ul{display:flex; gap:14px; list-style:none; align-items:center; margin:0; padding:0}
    .link{
      padding:9px 14px; border-radius:999px; color:var(--muted);
      border:1px solid transparent; transition:.2s ease;
    }
    .link:hover{color:#fff; border-color:#ffffff22; background:#ffffff12}
    .cta{
      background:linear-gradient(180deg, var(--brand), var(--brand-600));
      color:#0c120a; font-weight:800; letter-spacing:.2px;
      padding:10px 16px; border-radius:999px; box-shadow:var(--aura);
    }
    .cta:hover{filter:brightness(.95)}
    .cta-btn{
      display:inline-block;
      background:var(--glass);
      color:var(--brand); font-weight:600;
      padding:10px 18px; border-radius:999px;
      border:1px solid var(--brand-600);
      transition:all .2s ease; cursor:pointer;
    }
    .cta-btn:hover{ background:#3a4661; transform:translateY(-2px); }
    /* Success lock state for the CTA button */
    .cta-btn.is-selected{
      background:linear-gradient(180deg, var(--brand), var(--brand-600));
      color:#0c120a;
      border-color:var(--brand-600);
      box-shadow:0 0 0 3px rgba(92,140,69,.28);
      cursor:default;
    }
    .cta-btn.is-selected:disabled{ opacity:1; }
    .cta-btn.is-selected::after{
      content:" ✓";
      font-weight:700;
    }

    .section{max-width:var(--maxw); margin:36px auto; padding:0 20px}
    .glass{
      background:var(--glass); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--aura); padding:32px;
    }

    .dropdown { position: relative; }
    .dropdown-toggle {
      background: none;
      border: none;
      cursor: pointer;
      font: inherit;
      color: var(--muted);
      padding: 9px 14px;
      border-radius: 999px;
      transition: .2s ease;
    }
    .dropdown-toggle:hover {
      color: var(--muted);
      background: #ffffff12;
      border: 1px solid #ffffff22;
    }
    .dropdown-menu {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--glass-blur);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--aura);
      list-style: none;
      margin: 0;
      padding: 8px 0;
      min-width: 240px;
      z-index: 100;
    }
    .dropdown-menu li { padding: 0; }
    .dropdown-menu a {
      display: block;
      padding: 10px 16px;
      color: var(--muted);
      transition: background .2s ease;
    }
    .dropdown-menu a:hover {
      background: #ffffff12;
      color: var(--ink);
    }

    .option-card{
      flex:1 1 200px;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      text-align: center;
      padding:16px; cursor:pointer; transition:all .2s ease;
    }
    .option-card:hover{ background: var(--glass-2); border-color:var(--brand); }
    .option-card.selected{
      background: var(--glass-2); border-color:var(--brand);
      box-shadow:0 0 0 2px rgba(92,140,69,.35);
    }

    .table-wrapper{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-wrapper table{
      width:100%; border-collapse:collapse; min-width:500px;
      margin-top:1rem; font-size:.95rem;
    }
    th, td{ padding:12px; border-bottom:1px solid var(--border); }
    th{ background:var(--glass); color: var(--ink); }
    td:first-child{ text-align:left; }
    .check{ color:var(--brand-600); font-weight:700; text-align:center; }
    .cross{ color:var(--muted); font-weight:700; text-align:center; }
    .check::before {
      content: "";
      display: inline-block;
      width: 18px;
      height: 18px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpolyline points='20 6 9 17 4 12' fill='none' stroke='%231ca490' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
    }
    .cross::before {
      content: "✘";
      color: var(--muted);
      font-weight: bold;
      font-size: 1.2rem;
    }
    table td:nth-child(2),
    table td:nth-child(3),
    table td:nth-child(4),
    table td:nth-child(5),
    table th:nth-child(2),
    table th:nth-child(3),
    table th:nth-child(4),
    table th:nth-child(5){ text-align:center; }

    #ctaBox{ position:relative; }

    .sms-consent {
      display: flex;
      align-items: flex-start;
      margin: 8px 0;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .sms-consent input[type="checkbox"] {
      margin-right: 8px;
      accent-color: var(--brand-600); /* modern browsers */
    }
    #loadingOverlay{ display:none !important; }
    [hidden]{ display:none !important; }

    footer{ margin:50px 0 30px 0; color:var(--muted); text-align:center; font-size:.9rem }

    @media (max-width: 640px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ justify-content:center; margin-bottom:8px; }
      .site-label { flex-basis: 100%; text-align: center; margin-top: 2px; }
      nav ul{ flex-wrap:wrap; justify-content:center; gap:8px; }
      nav ul li{ flex:1 1 auto; display:flex; justify-content:center; }
      nav ul a{ width:100%; text-align:center; }
    }
    @media (max-width: 900px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ justify-content:center; margin-bottom:8px; }
      .site-label { flex-basis: 100%; text-align: center; margin-top: 2px; }
      nav ul{ flex-wrap:wrap; justify-content:center; gap:8px; }
      nav ul li{ flex:1 1 auto; display:flex; justify-content:center; }
      nav ul a{ width:100%; text-align:center; }
    }
    @media (max-width: 1100px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ justify-content:center; margin-bottom:8px; }
      .site-label { flex-basis: 100%; text-align: center; margin-top: 2px; }
      nav ul{ flex-wrap:wrap; justify-content:center; gap:8px; }
      nav ul li{ flex:1 1 auto; display:flex; justify-content:center; }
      nav ul a{ width:100%; text-align:center; }
    }
    .sms-consent .privacy-link {
      color: #4ecdc4; /* your mint accent */
      text-decoration: underline; /* optional */
      font-weight: 500; /* optional */
    }
    .sms-consent .privacy-link:hover {
      color: #38a89d; /* darker mint on hover */
    }
    .icon {
      width: 1.2rem;
      height: 1.2rem;
      fill: var(--brand-600);
      vertical-align: -0.2em;
      margin-right: 8px;
    }

    /* === Markdown Agreement Modal (public-facing) === */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 10000;
      background: rgba(0,0,0,.55);
      display: none;
    }
    .modal-overlay.is-open { display: block; }
    .modal {
      position: fixed; inset: 0; z-index: 10001;
      display: grid; place-items: center;
      pointer-events: none;
    }
    .modal.is-open { pointer-events: auto; }
    .modal-card {
      width: min(900px, 92vw); max-height: 85vh;
      background: var(--glass); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--aura);
      overflow: hidden; display: grid; grid-template-rows: auto 1fr auto;
    }
    .modal-head {
      padding: 14px 18px; border-bottom: 1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: var(--glass-2);
    }
    .modal-title { font-weight: 800; color: var(--ink); margin: 0; font-size: 1.05rem; }
    .modal-close { background: none; border: 0; color: var(--muted); font-weight: 700; cursor: pointer; }
    .modal-body {
      padding: 0; overflow: auto; background: #0a0f19;
    }
    .md-view { padding: 18px 22px; color: #dfe7ff; font-size: .98rem; line-height: 1.55; }
    .md-view h1,.md-view h2,.md-view h3,.md-view h4 { margin: 1.1em 0 .5em; }
    .md-view pre { background: #0f1626; padding: 10px 12px; border-radius: 10px; overflow: auto; }
    .md-view code { background: #0f1626; padding: 2px 6px; border-radius: 6px; }
    .modal-foot {
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      border-top: 1px solid var(--border); padding: 12px 16px; background: var(--glass-2);
    }
    .modal-foot .ack {
      display:flex; gap:10px; align-items:flex-start; color: var(--muted);
      font-size: .95rem;
    }
    .modal-foot .ack input[type="checkbox"] { accent-color: var(--brand-600); margin-top: 4px; }
    .modal-foot .actions { display: flex; gap: 10px; }
    .modal-foot .secondary { background:#ffffff12; border:1px solid #ffffff22; }
    .modal-foot .secondary:hover { background:#1e2a44; }
    .modal-foot .primary[disabled] { opacity:.6; pointer-events:none; }

    /* === Platform Subscription Wizard (post-login) === */
    .wizard { margin-top:24px; padding:20px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--glass-2); }
    .wizard .step { display:none; }
    .wizard .step.is-active { display:block; }
    .wizard .step h3 { margin:0 0 10px; color: var(--muted); }
    .wizard .controls { display:flex; gap:10px; margin-top:16px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#ffffff12; border:1px solid #ffffff22; font-size:.8rem; color:var(--muted); }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .field { flex:1 1 260px; }
    .hint { color:var(--muted); font-size:.9rem; }
  </style>
</head>
<body>
  <!-- Shimmer Loader (full-screen, hidden by default) -->
  <div id="page-loader" class="loader-shimmer" role="status" aria-live="polite" aria-hidden="true">
    <span class="sr-only">Loading…</span>
  </div>

  <div class="bg" aria-hidden="true"></div>
  <canvas id="bg-stars" aria-hidden="true"></canvas>

  <header>
    <div class="nav">
      <a class="brand" href="https://fortiviewholdings.com">
        <div class="logo" aria-hidden="true"></div>
        <strong style="color: var(--ink);">Fortiview</strong>
        <span style="color:var(--brand-600)">Holdings</span>
        <span class="site-label">PragOptics™ System Integration</span>
      </a>
      <nav aria-label="Primary">
        <ul>
          <li class="dropdown">
            <button class="link dropdown-toggle" onclick="toggleDropdown()">Services ▾</button>
            <ul id="servicesDropdown" class="dropdown-menu">
              <li><a href="/leadership">Leadership & Business Strategy</a></li>
              <li><a href="/operations">Project & Operations Management</a></li>
              <li><a href="/finance">Financial Coordination</a></li>
              <li><a href="/marketing">Marketing, Sales & Client Relations</a></li>
              <li><a href="/governance">Governance & Regulatory Support</a></li>
              <li><a href="/cx">Customer Experience Optimization</a></li>
              <li><a href="/partnerships">Networking & Partnerships</a></li>
              <li><a href="/industrial">Industrial Automation</a></li>
              <li><a href="/integration/">PragOptics™ System Integration</a></li>
              <li><a href="/YouthBusinessEducationSandbox/">Youth Entrepreneur Education</a></li>
            </ul>
          </li>
          <li><a class="link" href="/integration/terms">Terms & Conditions</a></li>
          <li><a class="cta" href="https://billing.stripe.com/p/login/4gM00beIf91O1Kzc3DdjO00">Manage Subscription</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- PragOptics Section -->
  <section id="integration" class="section">
    <div class="glass">
      <h2 style="margin-top:0; color:var(--muted)">PragOptics™<span style="color: var(--brand-600);"> System Integration</span></h2>
      <p style="color:var(--muted); font-size:1.05rem; line-height:1.6;">
        PragOptics™ is our framework for unifying your business systems into a single,
        transparent architecture. We connect your data, workflows, and customer touchpoints
        into dashboards that drive clarity and accountability.
      </p>
      <ul style="margin-top:16px; color:var(--ink); line-height:1.6; list-style:none; padding-left:0;">
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-integrate" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-integrate"></use></svg>
          Seamless integration of Microsoft 365, CRM, and POS systems</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-puzzle" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-puzzle"></use></svg>
          Software as a Solution (SaaS), delivering ready‑to‑use cloud applications that streamline operations without infrastructure overhead</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-dashboard" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-dashboard"></use></svg>
          Unified dashboards for finance, operations, and customer experience</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-energy" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-energy"></use></svg>
          Automation pipelines (Power Automate, PowerShell, Python)</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone"></use></svg>
          iOS & Web App Development – high‑performance mobile experiences that connect your customers and operations</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-fingerprint" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-fingerprint"></use></svg>
          Identity-aware access control and compliance-ready logging</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-scale" xlink:href="https://fortiviewholdings.com/icons/sprite.svg#icon-scale"></use></svg>
          Scalable architecture designed for growth and partnerships</li>
      </ul>

      <!-- Existing CTA Button (unchanged) -->
      <div style="margin-top:28px;">
        <button class="cta-btn" onclick="openCtaBox()">Select Your Package</button>
        <!-- NEW: API path CTA -->
        <button class="cta-btn" style="margin-left:12px" onclick="openAgreementModal()">
          Use PragOptics API
        </button>
      </div>

      <!-- Hidden Container (existing) -->
      <div id="ctaBox" class="glass" style="display:none; margin-top:20px; padding:20px;">
        <h3 style="margin-top:0; color:var(--muted)">Choose <span style="color: var(--brand-600)">Your Tier</span></h3>
        <div id="tierOptions" style="display:flex; gap:16px; flex-wrap:wrap;">
          <div class="option-card" onclick="selectTier(this,'Email Essentials')">
            <strong style="color: var(--ink)">Email Essentials</strong>
            <p style="color:var(--muted); font-size:.9rem;">Branded email, SharePoint, backend support</p>
          </div>
          <div class="option-card" onclick="selectTier(this,'Productivity Suite')">
            <strong style="color: var(--ink)">Productivity Suite</strong>
            <p style="color:var(--muted); font-size:.9rem;">Everything in Essentials + Office apps, Teams, automation</p>
          </div>
          <div class="option-card" onclick="selectTier(this,'Automation Builder')">
            <strong style="color: var(--ink)">Automation Builder</strong>
            <p style="color:var(--muted); font-size:.9rem;">Everything in Productivity + Power Automate Premium & Power Apps Plan w/ Fortiview Cloud-Sharing</p>
          </div>
          <div class="option-card" onclick="selectTier(this,'Super User Suite')">
            <strong style="color: var(--ink)">Super User Suite</strong>
            <p style="color:var(--muted); font-size:.9rem;">Everything in Automation + MS Agents</p>
          </div>
        </div>
        <!-- Payment Terms -->
        <div id="planBox" style="display:none; margin-top:24px;">
          <h3 style="margin-top:0; color:var(--muted)">Select <span style="color: var(--brand-600)">Payment Plan</span></h3>
          <div id="planOptions" style="display:flex; gap:16px; flex-wrap:wrap;">
            <div class="option-card" onclick="selectPlan(this,'Monthly')"><strong style="color: var(--ink)">Monthly</strong></div>
            <div class="option-card" onclick="selectPlan(this,'Quarterly')"><strong style="color: var(--ink)">Quarterly</strong></div>
            <div class="option-card" onclick="selectPlan(this,'Annual')"><strong style="color: var(--ink)">Annual</strong></div>
          </div>
        </div>
        <!-- Confirmation -->
        <div id="summaryBox" style="display:none; margin-top:24px; color:var(--ink);">
          <h3 style="margin-top:0; color:var(--brand-600)">Your <span style="color: var(--muted)">Selection</span></h3>
          <p id="summaryText"></p>
          <button id="submitBtn" class="cta-btn" style="margin-top:16px; display:none;" onclick="showContactForm()">
            Submit Request
          </button>
        </div>
        <!-- Contact Form (existing) -->
        <div id="contactForm" style="display:none; margin-top:24px;">
          <h3 style="margin-top:0; color:var(--muted)">Please Provide <span style="color: var(--brand-600)">Contact Information</span></h3>
          <form onsubmit="handleFormSubmit(event)" autocomplete="on">
            <label>
              Name:<br>
              <input type="text" id="custName" name="name" autocomplete="name"
                required style="width:100%; padding:8px; margin:6px 0;">
            </label><br>
            <label>
              Business Name:<br>
              <input type="text" id="businessName" name="organization" autocomplete="organization"
                required style="width:100%; padding:8px; margin:6px 0;">
            </label><br>
            <label>
              Email:<br>
              <input type="email" id="custEmail" name="email" autocomplete="email"
                required style="width:100%; padding:8px; margin:6px 0;">
            </label><br>
            <label>
              Phone:<br>
              <input type="tel" id="custPhone" name="tel" autocomplete="tel"
                inputmode="numeric" maxlength="10"
                placeholder="Enter 10 digits"
                style="width:100%; padding:8px; margin:6px 0;"
                onblur="formatPhone(this)">
            </label><br>
            <label>
              State:<br>
              <select id="custState" name="address-level1" autocomplete="address-level1"
                required style="width:100%; padding:8px; margin:6px 0;">
                <option value="">Select a state</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </label><br>
            <label class="sms-consent">
              <input type="checkbox" id="smsConsent" name="smsConsent">
              <span class="sms-text">
                I consent to receive informational/transactional SMS messages & Phone Calls from Fortiview Holdings in regards to account notifications and one-time passcodes. Message frequency varies. Message and data rates may apply. Reply STOP to opt-out.
                <a href="/integration/terms#privacy" class="privacy-link" target="_self">See our Privacy Policy</a>.
              </span>
            </label><br>
            <button type="submit" class="cta-btn" style="margin-top:12px;" data-act="integration">Finalize Request</button>
          </form>
        </div>
      </div>

      <!-- NEW: Platform Subscription Wizard (appears after successful CIAM login) -->
      <div id="platformFlow" class="wizard" style="display:none;" aria-live="polite">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0; color:var(--brand-600)">PragOptics™ Platform Subscription</h3>
          <span class="badge" id="authBadge" title="Authentication status">Signed out</span>
        </div>
        <p class="hint" style="margin-top:6px;">Complete these steps to create your billing profile and activate your PragOptics™ subscription.</p>

        <!-- Step 1: Choose Role -->
        <div id="step1" class="step is-active">
          <h3>Step 1 — Choose Subscriber Type</h3>
          <div class="row">
            <label class="option-card" style="text-align:left;">
              <input type="radio" name="subType" value="user" style="margin-right:10px;"> <strong>User</strong>
              <div class="hint">Base: <strong>$7.50/user/month</strong> — includes 10,000 API calls, 1 GB storage, website deploy, domain check.</div>
            </label>
            <label class="option-card" style="text-align:left;">
              <input type="radio" name="subType" value="partner" style="margin-right:10px;"> <strong>Partner</strong>
              <div class="hint">Base: <strong>$49/month</strong> — Partner RG + storage, custom namespace, onboard users, set retail pricing.</div>
            </label>
          </div>
          <div class="controls">
            <button class="cta-btn" onclick="gotoStep2()" id="toStep2" disabled>Next</button>
          </div>
        </div>

        <!-- Step 2: Choose Add-ons (varies) -->
        <div id="step2" class="step">
          <h3>Step 2 — Select Plan & Add‑Ons</h3>
          <div class="row">
            <div class="field">
              <label class="hint"><strong>Plan cadence</strong></label><br/>
              <label><input type="radio" name="cadence" value="monthly" checked> Monthly</label>&nbsp;&nbsp;
              <label><input type="radio" name="cadence" value="annual"> Annual</label>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="field">
              <label class="hint"><strong>Add‑ons (optional)</strong></label>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoDomains"> Domains + Business Email ($7.50/user/month)</label>
              </div>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoStorage"> Additional Storage ($2.00 per 5GB/month)</label>
              </div>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoFlows"> Workflow Bundle ($3.00 per 10,000 executions)</label>
              </div>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoApi"> API Bundle ($5.00 per 50,000 calls)</label>
              </div>
            </div>
            <div class="field">
              <div class="option-card" style="text-align:left;">
                <strong>Pricing Summary</strong>
                <div id="priceSummary" class="hint">Select options to view an estimate.</div>
              </div>
              <div class="hint" style="margin-top:8px;">Actual billing is finalized in Stripe after identity is verified.</div>
            </div>
          </div>
          <div class="controls">
            <button class="cta-btn secondary" onclick="gotoStep1()">Back</button>
            <button class="cta-btn" onclick="gotoStep3()">Next</button>
          </div>
        </div>

        <!-- Step 3: Billing Profile (requires token) -->
        <div id="step3" class="step">
          <h3>Step 3 — Create Billing Profile</h3>
          <p class="hint">You are signed in. Complete contact details to create your Stripe billing profile.</p>
          <form onsubmit="handleBillingProfile(event)">
            <div class="row">
              <div class="field">
                <label>Name<br>
                  <input id="bpName" type="text" required style="width:100%; padding:8px; margin:6px 0;">
                </label>
              </div>
              <div class="field">
                <label>Email<br>
                  <input id="bpEmail" type="email" required style="width:100%; padding:8px; margin:6px 0;">
                </label>
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label>Phone<br>
                  <input id="bpPhone" type="tel" style="width:100%; padding:8px; margin:6px 0;" onblur="formatPhone(this)">
                </label>
              </div>
              <div class="field">
                <label>Organization (optional)<br>
                  <input id="bpOrg" type="text" style="width:100%; padding:8px; margin:6px 0;">
                </label>
              </div>
            </div>
            <div class="controls">
              <button class="cta-btn secondary" type="button" onclick="gotoStep2()">Back</button>
              <button class="cta-btn" type="submit">Create Billing Profile</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Pricing Section (unchanged) -->
  <section id="pricing" class="section">
    <div class="glass">
      <h2 style="margin-top:0; color:var(--brand)">Strategic <span style="color: var(--muted)">Service Packages</span></h2>
      <p style="color:var(--ink); margin-bottom:24px;">
        Transparent pricing with scalable options. Every package includes a dedicated tenant,
        domain integration, and Fortiview-managed security.
      </p>
      <h3 style="margin-top:0; color:var(--muted)">One-Time Fee <span style="color: var(--brand-600)">$1500</span></h3>
      <ul>
        <li>Dedicated Microsoft 365 tenant creation</li>
        <li>Domain integration and DNS configuration</li>
        <li>Branded SharePoint environment</li>
        <li>Front-facing static website</li>
        <li>Identity and access control setup</li>
        <li>Initial user provisioning and license assignment</li>
        <li>Backend security enforcement and monitoring</li>
      </ul>

      <h3 style="margin-top:0; color:var(--muted)">Subscription Tiers <span style="color: var(--brand-600)">(Per User)</span></h3>
      <p style="text-align: center; color: var(--fg-light); font-size: 0.9em; margin-bottom: 0.5em;">
        ⟳ Rotate your <svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone"></use></svg>for Mobile Friendly View
      </p>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Service / Feature</th>
              <th>Email Essentials</th>
              <th>Productivity Suite</th>
              <th>Automation Builder</th>
              <th>Super User Suite</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Branded email under your domain</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Microsoft 365 license</td><td>Basic</td><td>Standard</td><td>Standard</td><td>Standard</td></tr>
            <tr><td>SharePoint access for document storage</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>DNS management (SPF, DKIM, DMARC)</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Fortiview-managed updates & security</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Ongoing backend support</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Business training & onboarding</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Microsoft Teams collaboration</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Microsoft Office apps (Word, Excel, Outlook, PowerPoint)</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Advanced SharePoint features</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Custom automation flows & app development</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>PowerApps Developer license</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Power Automate Premium license</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>iOS App development & connected customer experience</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Fortiview workflow sharing & cloud development</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>MS Agent access (up to 25k credits/month)</td><td class="cross"></td><td class="cross"></td><td class="cross"></td><td class="check"></td></tr>
            <tr><td>Additional agent usage billed separately</td><td class="cross"></td><td class="cross"></td><td class="cross"></td><td class="check"></td></tr>
          </tbody>
        </table>
      </div>

      <h3 style="margin-top:32px; color:var(--muted)">Pricing <span style="color: var(--brand-600);">(Per User)</span></h3>
      <p style="text-align: center; color: var(--fg-light); font-size: 0.9em; margin-bottom: 0.5em;">
        ⟳ Rotate your <svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone"></use></svg>for Mobile Friendly View
      </p>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Tier</th>
              <th>Monthly</th>
              <th>Quarterly <span style="color: var(--brand-600)">(5% off)</span></th>
              <th>Annual <span style="color: var(--brand-600)">(10% off)</span></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Email Essentials</td>
              <td>$10</td>
              <td>$28.50</td>
              <td>$108</td>
            </tr>
            <tr>
              <td>Productivity Suite</td>
              <td>$20</td>
              <td>$57.00</td>
              <td>$216</td>
            </tr>
            <tr>
              <td>Automation Builder</td>
              <td>$65</td>
              <td>$185.25</td>
              <td>$702</td>
            </tr>
            <tr>
              <td>Super User Suite</td>
              <td>$350</td>
              <td>$997.50</td>
              <td>$3,780</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <footer>
    <p>© 2025 Fortiview Holdings LLC — Secure, scalable, and fully managed.</p>
  </footer>

  <!-- MODAL: Public Subscriber Agreement -->
  <div id="agreementMask" class="modal-overlay" aria-hidden="true"></div>
  <div id="agreementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="agreementTitle" aria-hidden="true">
    <div class="modal-card" tabindex="-1">
      <div class="modal-head">
        <h3 id="agreementTitle" class="modal-title">PragOptics™ Subscriber & Partner Agreement <span class="badge">v1.0</span></h3>
        <button class="modal-close" type="button" aria-label="Close" onclick="closeAgreementModal()">✕</button>
      </div>
      <div class="modal-body">
        <div id="mdContainer" class="md-view" aria-live="polite">
          <p style="color:var(--muted)">Loading agreement…</p>
        </div>
      </div>
      <div class="modal-foot">
        <label class="ack">
          <input id="agreeChk" type="checkbox" />
          <span>I have read and agree to the PragOptics™ Subscriber & Partner Agreement (public). I acknowledge this acceptance may be recorded for compliance and onboarding.</span>
        </label>
        <div class="actions">
          <button type="button" class="cta-btn secondary" onclick="closeAgreementModal()">Cancel</button>
          <button id="agreeGoBtn" type="button" class="cta-btn primary" onclick="submitAgreementAck()" disabled>Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ===========================
  // Dropdown handling
  // ===========================
  function toggleDropdown() {
    const menu = document.getElementById('servicesDropdown');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
  }
  document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
      const menu = document.getElementById('servicesDropdown');
      if (menu) menu.style.display = 'none';
    }
  });

  // ===========================
  // Global shimmer loader + viewport reset
  // ===========================
  function resetViewportScale(options = { allowPinchAfter: true }) {
    let meta = document.querySelector('meta[name="viewport"]');
    if (!meta) {
      meta = document.createElement('meta');
      meta.name = 'viewport';
      document.head.appendChild(meta);
    }
    const base = 'width=device-width';
    meta.content = base + ', initial-scale=1.0001';
    requestAnimationFrame(() => {
      meta.content =
        base + ', initial-scale=1.0' +
        (options.allowPinchAfter ? ', user-scalable=yes' : ', maximum-scale=1.0');
    });
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
    setTimeout(() => { window.scrollTo(0, Math.max(0, window.pageYOffset + 0)); }, 0);
  }
  const htmlEl = document.documentElement;
  const loaderEl = document.getElementById('page-loader');
  function startLoading({ resetZoom = true } = {}) {
    if (resetZoom) resetViewportScale();
    htmlEl.classList.add('is-loading');
    if (loaderEl) loaderEl.setAttribute('aria-hidden', 'false');
  }
  function stopLoading() {
    htmlEl.classList.remove('is-loading');
    if (loaderEl) loaderEl.setAttribute('aria-hidden', 'true');
  }
  window.pageLoader = { start: startLoading, stop: stopLoading, resetViewportScale };

  // ===========================
  // Tier/Plan selection (existing)
  // ===========================
  let selectedTier = null;
  let selectedPlan = null;
  function openCtaBox() {
    document.getElementById('ctaBox').style.display = 'block';
    try { document.getElementById('ctaBox').scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
  }
  function selectTier(el, tier) {
    document.querySelectorAll('#tierOptions .option-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedTier = tier;
    document.getElementById('planBox').style.display = 'block';
    updateSummary();
  }
  function selectPlan(el, plan) {
    document.querySelectorAll('#planOptions .option-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedPlan = plan.toLowerCase();
    updateSummary();
  }
  function updateSummary() {
    if (selectedTier && selectedPlan) {
      document.getElementById('summaryBox').style.display = 'block';
      document.getElementById('summaryText').textContent =
        `You selected: ${selectedTier} with ${selectedPlan} billing.`;
      document.getElementById('submitBtn').style.display = 'inline-block';
    }
  }
  function showContactForm() { document.getElementById('contactForm').style.display = 'block'; }

  // ===========================
  // Phone formatting
  // ===========================
  function formatPhone(input) {
    let digits = input.value.replace(/\D/g, '').substring(0, 10);
    if (digits.length === 10) {
      const area = digits.substring(0,3);
      const mid  = digits.substring(3,6);
      const last = digits.substring(6);
      input.value = `+1 (${area}) ${mid}-${last}`;
      input.dataset.raw = digits;
    } else {
      input.value = digits;
      input.dataset.raw = digits;
    }
  }

  // ===========================
  // Pricing configuration (existing for services)
  // ===========================
  const INITIAL_SETUP_FEE = 1500;
  const PRICING_MATRIX = {
    "Email Essentials": { monthly: 10, quarterly: 28.50, annual: 108 },
    "Productivity Suite": { monthly: 20, quarterly: 57,   annual: 216 },
    "Automation Builder": { monthly: 65, quarterly: 185.25, annual: 702 },
    "Super User Suite": { monthly: 350, quarterly: 997.50, annual: 3780 }
  };

  // ===========================
  // OmniTok integration (existing)
  // ===========================
  const API = {
    issueOmniTok: 'https://default6eda43f3fbf04e2b9978b543d9dd31.e3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4be2293ea9ca4e418ac17059d7209cf1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vGhxzQ1mnf06FenEffQzPjo1iP_OLyKLH-yzAkPGUjo' // replace with endpoint
  };
  async function getOmniTok(act) {
    let sid = sessionStorage.getItem('sid');
    if (!sid) { sid = crypto.randomUUID(); sessionStorage.setItem('sid', sid); }
    let body = (typeof act === 'string') ? { act, sid } : { sid, ...act };
    const res = await fetch(API.issueOmniTok, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Failed to get OmniTok config for ${body.act ?? act}`);
    const data = await res.json();
    return { ...data, sid };
  }

  // ===========================
  // Existing contact form handler (unchanged)
  // ===========================
  async function handleFormSubmit(e) {
    e.preventDefault();
    const btn = e.submitter;
    const act = btn?.dataset.act ?? 'integration';
    const jobId = `IntReq-${crypto.randomUUID()}`;
    const perUserPrice = PRICING_MATRIX[selectedTier]?.[selectedPlan] ?? 0;
    const customerData = {
      jobId,
      name: document.getElementById('custName').value,
      business: document.getElementById('businessName').value,
      email: document.getElementById('custEmail').value,
      phoneRaw: document.getElementById('custPhone').dataset.raw ?? "",
      phoneFormatted: document.getElementById('custPhone').value,
      state: document.getElementById('custState').value,
      tier: selectedTier,
      plan: selectedPlan,
      setupFee: Number(INITIAL_SETUP_FEE),
      perUserPrice: Number(perUserPrice),
      smsConsent: document.getElementById('smsConsent').checked
    };
    btn.disabled = true;
    document.querySelectorAll('#ctaBox input, #ctaBox select, #ctaBox button').forEach(el => el.disabled = true);
    startLoading({ resetZoom: true });
    try {
      const omni = await getOmniTok(act);
      if (!omni.endpoint) throw new Error("Omnitok preflight did not return an endpoint");
      const response = await fetch(omni.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-auth-token': omni.authToken,
          'x-omnitok': omni.OmniTok,
          'x-sid': omni.sid,
          'x-act': omni.act
        },
        body: JSON.stringify(customerData)
      });
      if (!response.ok) throw new Error("Backend rejected request");
      const result = await response.json();
      const ctaBox = document.getElementById('ctaBox');
      if (ctaBox) ctaBox.setAttribute('hidden', '');
      const selectBtn = document.querySelector('.cta-btn');
      if (selectBtn) {
        selectBtn.textContent = 'Package selected';
        selectBtn.classList.add('is-selected');
        selectBtn.disabled = true;
      }
      alert(
        `✅ Your request has been sent!\n\n` +
        `We've emailed a confirmation to: ${result.email ?? customerData.email}\n` +
        `If you don't see it, please check your spam folder and mark us as a trusted sender.\n\n` +
        `Tracking ID: ${jobId}`
      );
    } catch (err) {
      console.error("Submission error:", err);
      btn.disabled = false;
      document.querySelectorAll('#ctaBox input, #ctaBox select, #ctaBox button').forEach(el => el.disabled = false);
      alert("❌ Your request did not go through.\n\nPlease try again in a moment. If the problem persists, contact support.");
    } finally {
      stopLoading();
    }
  }

  // ===========================
  // Agreement Modal + Markdown viewer
  // ===========================
  const AGREEMENT_MD_URL = 'https://fortiviewholdings.com/docs/PragOptics-Subscriber-Agreement.md'; // update path if needed
  const CIAM_LOGIN_INIT = '/api/v1/auth/login'; // backend that returns { authorizeUrl, state, flow } (like devconsole)
  const $modal = document.getElementById('agreementModal');
  const $mask  = document.getElementById('agreementMask');
  const $md    = document.getElementById('mdContainer');
  const $agree = document.getElementById('agreeChk');
  const $go    = document.getElementById('agreeGoBtn');
  let modalFocusTrap = null;

  function mdToHtml(md) {
    const esc = s => s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    md = md.replace(/```([\s\S]*?)```/g, (_,code)=>`<pre><code>${esc(code)}</code></pre>`);
    md = md.replace(/`([^`]+)`/g, (_,c)=>`<code>${esc(c)}</code>`);
    md = md.replace(/^######\s?(.*)$/gm,'<h6>$1</h6>')
           .replace(/^#####\s?(.*)$/gm,'<h5>$1</h5>')
           .replace(/^####\s?(.*)$/gm,'<h4>$1</h4>')
           .replace(/^###\s?(.*)$/gm,'<h3>$1</h3>')
           .replace(/^##\s?(.*)$/gm,'<h2>$1</h2>')
           .replace(/^#\s?(.*)$/gm,'<h1>$1</h1>');
    md = md.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
           .replace(/\*([^*]+)\*/g,'<em>$1</em>');
    md = md.replace(/^(?:\s*[-*+]\s+.*(?:\n|$))+?/gm, block => {
      const items = block.trim().split(/\n/).map(l => l.replace(/^\s*[-*+]\s+/, '')).map(t=>`<li>${t}</li>`).join('');
      return `<ul>${items}</ul>`;
    });
    md = md.replace(/^(?!<h\d|<ul|<pre|<p|<\/|\s*$)(.+)$/gm,'<p>$1</p>');
    return md;
  }
  async function openAgreementModal() {
    try {
      $md.innerHTML = '<p style="color:var(--muted)">Loading agreement…</p>';
      $agree.checked = false; $go.disabled = true;
      $mask.classList.add('is-open'); $modal.classList.add('is-open');
      $modal.setAttribute('aria-hidden','false'); $mask.setAttribute('aria-hidden','false');

      const res = await fetch(AGREEMENT_MD_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('Agreement not available');
      const text = await res.text();
      $md.innerHTML = mdToHtml(text);

      const card = $modal.querySelector('.modal-card'); card.focus(); trapFocus($modal);
    } catch(err) {
      console.error(err);
      $md.innerHTML = '<p style="color:#ffb4a4">Unable to load agreement. Please try again later.</p>';
    }
  }
  function closeAgreementModal() {
    $mask.classList.remove('is-open'); $modal.classList.remove('is-open');
    $modal.setAttribute('aria-hidden','true'); $mask.setAttribute('aria-hidden','true');
    releaseFocus();
  }
  $agree?.addEventListener('change', () => { $go.disabled = !$agree.checked; });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && $modal.classList.contains('is-open')) closeAgreementModal(); });
  $mask?.addEventListener('click', closeAgreementModal);

  function trapFocus(scope) {
    const FOCUSABLE = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
    const nodes = Array.from(scope.querySelectorAll(FOCUSABLE)).filter(el => el.offsetParent !== null);
    const first = nodes[0], last = nodes[nodes.length - 1];
    modalFocusTrap = (e) => {
      if (e.key !== 'Tab') return;
      if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
      else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
    };
    scope.addEventListener('keydown', modalFocusTrap);
  }
  function releaseFocus() {
    if (!modalFocusTrap) return;
    $modal.removeEventListener('keydown', modalFocusTrap);
    modalFocusTrap = null;
  }

  // Agreement submit -> OmniTok log -> CIAM redirect -> return here
  async function submitAgreementAck() {
    if (!$agree.checked) return;
    const jobId = `Agree-${crypto.randomUUID()}`;
    const sid = sessionStorage.getItem('sid') || (sessionStorage.setItem('sid', crypto.randomUUID()), sessionStorage.getItem('sid'));
    const payload = { act: 'api_agreement_ack_v1', sid, jobId, agreed: true, mdVersion: 'v1.0', source: 'public_site', timestamp: new Date().toISOString() };

    try {
      startLoading({ resetZoom: true });
      // Log acceptance
      const omni = await getOmniTok(payload);
      if (!omni.endpoint) throw new Error('Omnitok did not return an endpoint');
      await fetch(omni.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-auth-token': omni.authToken, 'x-omnitok': omni.OmniTok, 'x-sid': omni.sid, 'x-act': omni.act
        },
        body: JSON.stringify({ jobId, sid, agreed: true, mdVersion: 'v1.0' })
      });

      // Start CIAM login like devconsole: request authorizeUrl then redirect (preserve a post=subscribe hint)
      const returnUrl = encodeURIComponent(`${location.origin}${location.pathname}?post=subscribe`);
      const authInit = await fetch(`${CIAM_LOGIN_INIT}?returnUrl=${returnUrl}`);
      const data = await authInit.json(); // expects { authorizeUrl, state, flow }
      closeAgreementModal();
      location.href = data.authorizeUrl; // redirect to CIAM
    } catch (err) {
      console.error(err);
      alert('Unable to proceed. Please try again.');
    } finally {
      stopLoading();
    }
  }

  // ===========================
  // DevConsole-like callback handler (reads ?authResult=...)
  // ===========================
  let pragopticsToken = null;
  function readTokensFromSession() {
    try {
      const stored = JSON.parse(sessionStorage.getItem("pragoptics_tokens"));
      return stored || null;
    } catch { return null; }
  }
  function decodeJwtPayload(tok) {
    try {
      const parts = tok.split('.');
      if (parts.length < 2) return {};
      const b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
      const pad = b64 + '==='.slice((b64.length + 3) % 4);
      return JSON.parse(atob(pad));
    } catch { return {}; }
  }
  async function handlePragOpticsCallback() {
    const params = new URLSearchParams(window.location.search);
    const authResultEncoded = params.get("authResult"); // same as devconsole
    if (!authResultEncoded) {
      // not a callback; if already logged in and post=subscribe, open the wizard
      const existing = readTokensFromSession();
      if (existing?.access_token && (params.get('post') === 'subscribe')) { initPostLoginWizard(existing.access_token); }
      return;
    }
    const statusBadge = document.getElementById('authBadge');
    let authResult;
    try { authResult = JSON.parse(decodeURIComponent(authResultEncoded)); }
    catch (e) {
      statusBadge.textContent = "Login failed";
      alert("Login failed: invalid callback payload.");
      return;
    }
    if (!authResult.success) {
      statusBadge.textContent = "Login failed";
      alert(`Login failed: ${authResult.errorDescription ?? authResult.error}`);
      return;
    }
    // SUCCESS
    const tokens = authResult.tokens;
    const accessToken = tokens?.access_token ?? null;
    sessionStorage.setItem("pragoptics_tokens", JSON.stringify(tokens));
    pragopticsToken = accessToken;

    // Clean authResult off URL
    const post = (new URLSearchParams(window.location.search)).get('post') ?? 'subscribe';
    window.history.replaceState({}, document.title, `${location.pathname}?post=${post}`);

    initPostLoginWizard(accessToken);
  }
  window.addEventListener("load", handlePragOpticsCallback);

  // ===========================
  // Post-login: show Platform Wizard, prefill fields, compute pricing
  // ===========================
  const PLATFORM_PRICING = {
    userBase: 7.50,
    partnerPremium: 49.00,
    addons: { domainsEmail: 7.50, storage5gb: 2.00, flows10k: 3.00, api50k: 5.00 }
  };
  let selectedType = null;
  function initPostLoginWizard(accessToken) {
    // Show signed-in badge
    const badge = document.getElementById('authBadge');
    badge.textContent = "Signed in";
    badge.style.color = '#21bca5';
    // Try to prefill from JWT
    const claims = decodeJwtPayload(accessToken || "");
    document.getElementById('bpEmail').value = claims.email || '';
    document.getElementById('bpName').value = claims.name || '';
    // Show wizard
    document.getElementById('platformFlow').style.display = 'block';
    // wire radios
    document.querySelectorAll('input[name="subType"]').forEach(r => {
      r.addEventListener('change', () => {
        selectedType = r.value; document.getElementById('toStep2').disabled = !selectedType;
        updatePriceSummary();
      });
    });
    document.querySelectorAll('input[name="cadence"]').forEach(r => r.addEventListener('change', updatePriceSummary));
    ['aoDomains','aoStorage','aoFlows','aoApi'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', updatePriceSummary);
    });
    updatePriceSummary();
    // Scroll into view
    try { document.getElementById('platformFlow').scrollIntoView({ behavior: 'smooth' }); } catch {}
  }
  function gotoStep1() {
    document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active'));
    document.getElementById('step1').classList.add('is-active');
  }
  function gotoStep2() {
    if (!selectedType) return;
    document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active'));
    document.getElementById('step2').classList.add('is-active');
    updatePriceSummary();
  }
  function gotoStep3() {
    document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active'));
    document.getElementById('step3').classList.add('is-active');
  }
  function updatePriceSummary() {
    const cadence = (document.querySelector('input[name="cadence"]:checked')?.value) || 'monthly';
    const ao = {
      domains: document.getElementById('aoDomains')?.checked,
      storage: document.getElementById('aoStorage')?.checked,
      flows:   document.getElementById('aoFlows')?.checked,
      api:     document.getElementById('aoApi')?.checked
    };
    let base = (selectedType === 'partner') ? PLATFORM_PRICING.partnerPremium : PLATFORM_PRICING.userBase;
    let addons = 0;
    if (selectedType === 'user') {
      if (ao.domains) addons += PLATFORM_PRICING.addons.domainsEmail;
      if (ao.storage) addons += PLATFORM_PRICING.addons.storage5gb;
      if (ao.flows)   addons += PLATFORM_PRICING.addons.flows10k;
      if (ao.api)     addons += PLATFORM_PRICING.addons.api50k;
    } else {
      // partner: keep summary minimal (addons are typically per-user)
      if (ao.domains || ao.storage || ao.flows || ao.api) addons += 0; // informational
    }
    // annual simple 10% off preview
    const est = (cadence === 'annual') ? (base + addons) * 12 * 0.90 : (base + addons);
    const summary = document.getElementById('priceSummary');
    summary.innerHTML = `
      <div><strong>${selectedType ? selectedType.toUpperCase() : 'Select type'}</strong> — base: $${base.toFixed(2)} ${selectedType==='user'?'/user/mo':''}</div>
      ${selectedType==='user' ? `<div>Add‑ons est.: $${addons.toFixed(2)} /mo</div>` : ``}
      <div><em>Cadence:</em> ${cadence}</div>
      <div style="margin-top:6px;"><strong>Estimated ${cadence === 'annual' ? 'Annualized' : 'Monthly'} Total:</strong> $${est.toFixed(2)} ${selectedType==='user' && cadence!=='annual' ? '/user/mo' : ''}</div>
      <div class="hint" style="margin-top:6px;">Final pricing occurs in Stripe after identity is verified.</div>
    `;
  }

  // ===========================
  // Billing Profile submit (needs token)
  // ===========================
  async function handleBillingProfile(e) {
    e.preventDefault();
    const tokens = readTokensFromSession();
    const accessToken = tokens?.access_token;
    if (!accessToken) { alert('Please sign in first.'); return; }

    const cadence = (document.querySelector('input[name="cadence"]:checked')?.value) || 'monthly';
    const payload = {
      act: 'billing_profile_request_v1',
      jobId: `BP-${crypto.randomUUID()}`,
      subType: selectedType || 'user',
      cadence,
      addons: {
        domains: !!document.getElementById('aoDomains')?.checked,
        storage: !!document.getElementById('aoStorage')?.checked,
        flows:   !!document.getElementById('aoFlows')?.checked,
        api:     !!document.getElementById('aoApi')?.checked
      },
      contact: {
        name:  document.getElementById('bpName').value,
        email: document.getElementById('bpEmail').value,
        phone: document.getElementById('bpPhone').value,
        org:   document.getElementById('bpOrg').value
      },
      tokenPreview: accessToken?.slice(0,18) + '…' // do not send full token to client logs
    };

    try {
      startLoading({ resetZoom: true });
      // OmniTok preflight
      const omni = await getOmniTok(payload);
      if (!omni.endpoint) throw new Error('Omnitok did not return an endpoint');

      // Send to backend (Power Automate / your function)
      const res = await fetch(omni.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`, // token required to create billing profile
          'x-auth-token': omni.authToken, 'x-omnitok': omni.OmniTok, 'x-sid': omni.sid, 'x-act': omni.act
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Backend rejected billing profile request');
      const data = await res.json();
      alert('✅ Billing profile request received. Check your email to continue in Stripe.');
      // optionally redirect or advance flow here:
      // location.href = data.next ?? '/onboarding';
    } catch (err) {
      console.error(err);
      alert('❌ Could not create billing profile. Please try again.');
    } finally {
      stopLoading();
    }
  }

  // ===========================
  // Starfield background (existing)
  // ===========================
  function initStarField() {
    const canvas = document.getElementById('bg-stars');
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    const stars = Array.from({ length: 120 }, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 1.6 + 0.4,
      a: Math.random()
    }));
    let frame = 0, reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    function animate() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for (const s of stars) {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${s.a})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
        if(!reduce){ s.a = 0.25 + Math.abs(Math.sin((frame/60) + s.x*0.001 + s.y*0.001)) * 0.75; }
      }
      frame++; requestAnimationFrame(animate);
    }
    animate();
  }
  window.addEventListener('load', initStarField);
  </script>
</body>
</html>
