<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fortiview Holdings — PragOptics™ System Integration</title>
  <meta name="description" content="PragOptics™ is our framework for unifying your business systems into a single, transparent architecture. We connect your data, workflows, and customer touchpoints into dashboards that drive clarity and accountability.">
  <meta name="color-scheme" content="dark light" />
  <!-- Canonical -->
  <link rel="canonical" href="https://fortiviewholdings.com/integration/">
  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Fortiview Holdings">
  <meta property="og:title" content="Fortiview Holdings — PragOptics™ System Integration">
  <meta property="og:description" content="Secure, branded backend solutions that empower small businesses with clarity, trust, and scalability.">
  <meta property="og:image" content="https://fortiviewholdings.com/images/social-preview.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://fortiviewholdings.com/integration/">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://fortiviewholdings.com/images/social-preview.png">
  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.webmanifest">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"Fortiview Holdings",
    "url":"https://fortiviewholdings.com",
    "logo":"https://fortiviewholdings.com/images/logo.png",
    "image":"https://fortiviewholdings.com/images/social-preview.png",
    "sameAs":[
      "https://www.linkedin.com/company/fortiviewholdings",
      "https://www.instagram.com/fortiviewholdings"
    ]
  }
  </script>

  <style>
    :root{
      --bg-deep:#000000cc;
      --bg-accent:#101625cc;
      --glass:#d9d9d912;
      --glass-2:#00000012;
      --glass-blur:#000000d0;
      --border:#ffffff1a;
      --ink:#e7ecff;
      --muted:#c6d0f0a6;
      --brand:#1ca490da;
      --brand-600:#21bca5;
      --brandsoft:#21bca588;
      --aura:0 4px 8px rgba(17, 76, 67, 0.678);
      --radius:16px;
      --radius-sm:12px;
      --maxw:1200px;
      --grad:linear-gradient(135deg,#121b2d 0%,#060e1e 40%,#0f1824 100%);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg-deep); color:var(--ink);
      scroll-behavior:smooth;
      -webkit-text-size-adjust:100%;
    }
    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}

    .bg{
      position:fixed; inset:0; z-index:-2;
      background: var(--glass);
      filter:blur(6px) brightness(.9) saturate(1.05);
      transform:scale(1.03);
    }
    .bg::after{ content:""; position:absolute; inset:0; background: var(--glass); }
    #bg-stars{ position:fixed; inset:0; width:100vw; height:100vh; z-index:-1; pointer-events:none; }

    /* Screen-reader only helper */
    .sr-only { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* ===== Global full-screen shimmer overlay (hidden by default) ===== */
    .loader-shimmer{
      position:fixed; inset:0; z-index:9999;
      pointer-events:auto;
      opacity:0; visibility:hidden;
      transition:opacity 160ms ease, visibility 0s linear 160ms;
      background-color:rgba(0,0,0,0.06);
      background-image:linear-gradient(
        90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.18) 40%,
        rgba(255,255,255,0.45) 50%,
        rgba(255,255,255,0.18) 60%,
        rgba(255,255,255,0) 100%
      );
      background-size:200% 100%;
      will-change:opacity, background-position;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    html.is-loading .loader-shimmer{ opacity:1; visibility:visible; transition:opacity 160ms ease; animation:shimmer-sweep 1.25s linear infinite; }
    @keyframes shimmer-sweep{ 0%{ background-position:-200% 0; } 100%{ background-position:200% 0; } }
    html.is-loading{ overflow:hidden; }
    @media (prefers-reduced-motion: reduce){ html.is-loading .loader-shimmer{ animation:none; } }

    input, select, textarea { font-size:16px; } /* Keep iOS from zooming inputs */

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(10px);
      background:var(--glass);
      border-bottom:1px solid var(--border);
    }
    .nav{ max-width:var(--maxw); margin:0 auto; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand{display:flex; align-items:center; gap:10px; letter-spacing:.4px; flex-wrap: wrap;}
    .site-label { color: var(--muted); font-size: .95rem; white-space: nowrap;}
    .logo{
      width:34px; height:34px; border-radius:10px;
      background-image:url('https://fortiviewholdings.com/images/Logo.png');
      background-size:cover; background-position:center;
      box-shadow:0 0 0 2px rgba(92,140,69,.25), 0 10px 20px rgba(92,140,69,.18);
    }
    .brand strong{font-weight:800}
    nav ul{display:flex; gap:14px; list-style:none; align-items:center; margin:0; padding:0}
    .link{ padding:9px 14px; border-radius:999px; color:var(--muted); border:1px solid transparent; transition:.2s ease; }
    .link:hover{color:#fff; border-color:#ffffff22; background:#ffffff12}
    .cta{ background:linear-gradient(180deg, var(--brand), var(--brand-600)); color:#0c120a; font-weight:800; letter-spacing:.2px; padding:10px 16px; border-radius:999px; box-shadow:var(--aura); }
    .cta:hover{filter:brightness(.95)}
    .cta-btn{
      display:inline-block; background:var(--glass); color:var(--brand); font-weight:600;
      padding:10px 18px; border-radius:999px; border:1px solid var(--brand-600);
      transition:all .2s ease; cursor:pointer;
    }
    .cta-btn:hover{ background:#3a4661; transform:translateY(-2px); }
    .cta-btn.is-selected{ background:linear-gradient(180deg, var(--brand), var(--brand-600)); color:#0c120a; border-color:var(--brand-600); box-shadow:0 0 0 3px rgba(92,140,69,.28); cursor:default; }
    .cta-btn.is-selected:disabled{ opacity:1; }
    .cta-btn.is-selected::after{ content:" ✓"; font-weight:700; }

    .section{max-width:var(--maxw); margin:36px auto; padding:0 20px}
    .glass{ background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--aura); padding:32px; }

    .dropdown { position: relative; }
    .dropdown-toggle {
      background: none; border: none; cursor: pointer; font: inherit;
      color: var(--muted); padding: 9px 14px; border-radius: 999px; transition: .2s ease;
    }
    .dropdown-toggle:hover { color: var(--muted); background: #ffffff12; border: 1px solid #ffffff22; }
    .dropdown-menu {
      display: none; position: absolute; top: 110%; left: 0; background: var(--glass-blur);
      border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--aura);
      list-style: none; margin: 0; padding: 8px 0; min-width: 240px; z-index: 100;
    }
    .dropdown-menu a { display: block; padding: 10px 16px; color: var(--muted); transition: background .2s ease; }
    .dropdown-menu a:hover { background: #ffffff12; color: var(--ink); }

    .option-card{
      flex:1 1 200px; background:var(--glass); border:1px solid var(--border);
      border-radius:var(--radius-sm); text-align: center; padding:16px; cursor:pointer; transition:all .2s ease;
    }
    .option-card:hover{ background: var(--glass-2); border-color:var(--brand); }
    .option-card.selected{ background: var(--glass-2); border-color:var(--brand); box-shadow:0 0 0 2px rgba(92,140,69,.35); }

    .table-wrapper{ width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .table-wrapper table{ width:100%; border-collapse:collapse; min-width:500px; margin-top:1rem; font-size:.95rem; }
    th, td{ padding:12px; border-bottom:1px solid var(--border); }
    th{ background:var(--glass); color: var(--ink); }
    td:first-child{ text-align:left; }
    .check{ color:var(--brand-600); font-weight:700; text-align:center; }
    .cross{ color:var(--muted); font-weight:700; text-align:center; }
    .check::before {
      content: ""; display: inline-block; width: 18px; height: 18px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpolyline points='20 6 9 17 4 12' fill='none' stroke='%231ca490' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-size: contain; background-repeat: no-repeat; vertical-align: middle;
    }
    .cross::before { content: "✘"; color: var(--muted); font-weight: bold; font-size: 1.2rem; }
    .star{ color:var(--brand); font-weight:700; text-align:center; }
    .star::before { content: "★"; color: var(--brand-600); font-weight: bold; font-size: 1.2rem; }
    table td:nth-child(2), table td:nth-child(3), table td:nth-child(4), table td:nth-child(5),
    table th:nth-child(2), table th:nth-child(3), table th:nth-child(4), table th:nth-child(5){ text-align:center; }

    #ctaBox{ position:relative; }

    .sms-consent { display: flex; align-items: flex-start; margin: 8px 0; font-size: 0.9rem; color: var(--muted); }
    .sms-consent input[type="checkbox"] { margin-right: 8px; accent-color: var(--brand-600); }
    #loadingOverlay{ display:none !important; }
    [hidden]{ display:none !important; }

    footer{ margin:50px 0 30px 0; color:var(--muted); text-align:center; font-size:.9rem }

    @media (max-width: 640px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ justify-content:center; margin-bottom:8px; }
      .site-label { flex-basis: 100%; text-align: center; margin-top: 2px; }
      nav ul{ flex-wrap:wrap; justify-content:center; gap:8px; }
      nav ul li{ flex:1 1 auto; display:flex; justify-content:center; }
      nav ul a{ width:100%; text-align:center; }
    }
    @media (max-width: 900px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ justify-content:center; margin-bottom:8px; }
      .site-label { flex-basis: 100%; text-align: center; margin-top: 2px; }
      nav ul{ flex-wrap:wrap; justify-content:center; gap:8px; }
      nav ul li{ flex:1 1 auto; display:flex; justify-content:center; }
      nav ul a{ width:100%; text-align:center; }
    }
    @media (max-width: 1100px){
      .nav{ flex-direction:column; align-items:stretch; }
      .brand{ justify-content:center; margin-bottom:8px; }
      .site-label { flex-basis: 100%; text-align: center; margin-top: 2px; }
      nav ul{ flex-wrap:wrap; justify-content:center; gap:8px; }
      nav ul li{ flex:1 1 auto; display:flex; justify-content:center; }
      nav ul a{ width:100%; text-align:center; }
    }
    .sms-consent .privacy-link { color: #4ecdc4; text-decoration: underline; font-weight: 500; }
    .sms-consent .privacy-link:hover { color: #38a89d; }

    .icon { width: 1.2rem; height: 1.2rem; fill: var(--brand-600); vertical-align: -0.2em; margin-right: 8px; }

    /* === Markdown Agreement Modal (public-facing) === */
    .modal-overlay { position: fixed; inset: 0; z-index: 10000; background: var(--glass-blur); display: none; }
    .modal-overlay.is-open { display: block; }

    /* IMPORTANT: hidden by default to prevent showing on first paint */
    .modal { position: fixed; inset: 0; z-index: 10001; display: none; place-items: center; pointer-events: none; }
    .modal.is-open { display: grid; pointer-events: auto; }

    .modal-card {
      width: min(900px, 92vw); max-height: 85vh;
      background: var(--glass); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--aura);
      overflow: hidden; display: grid; grid-template-rows: auto 1fr auto;
    }
    .modal-head { padding: 14px 18px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px; background: var(--glass-2); }
    .modal-title { font-weight: 800; color: var(--ink); margin: 0; font-size: 1.05rem; }
    .modal-close { background: none; border: 0; color: var(--muted); font-weight: 700; cursor: pointer; }
    .modal-close:hover { background: var(--brandsoft); border: 1px solid var(--brand-600); border-radius: 4px; color: var(--muted); font-weight: 700; cursor: pointer; }
    .modal-body { padding: 0; overflow: auto; background: #0a0f19; }
    .md-view { padding: 18px 22px; color: #dfe7ff; font-size: .98rem; line-height: 1.55; }
    .md-view h1,.md-view h2,.md-view h3,.md-view h4 { margin: 1.1em 0 .5em; }
    .md-view pre { background: #0f1626; padding: 10px 12px; border-radius: 10px; overflow: auto; }
    .md-view code { background: #0f1626; padding: 2px 6px; border-radius: 6px; }

    /* tables inside Markdown preview */
    .md-view table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    .md-view th, .md-view td { padding: 8px; border: 1px solid var(--border); }
    .md-view thead th { background: var(--glass); color: var(--ink); text-align: left; }

    .modal-foot {
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      border-top: 1px solid var(--border); padding: 12px 16px; background: var(--glass-2);
    }
    .modal-foot .ack { display:flex; gap:10px; align-items:flex-start; color: var(--muted); font-size: .95rem; }
    .modal-foot .ack input[type="checkbox"] { accent-color: var(--brand-600); margin-top: 4px; }
    .modal-foot .actions { display: flex; gap: 10px; }
    .modal-foot .secondary { background:#ffffff12; border:1px solid #ffffff22; }
    .modal-foot .secondary:hover { background:#1e2a44; }
    .modal-foot .primary[disabled] { opacity:.6; pointer-events:none; }

    /* === Platform Subscription Wizard (post-login) === */
    .wizard { margin-top:24px; padding:20px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--glass-2); }
    .wizard .step { display:none; }
    .wizard .step.is-active { display:block; }
    .wizard .step h3 { margin:0 0 10px; color: var(--muted); }
    .wizard .controls { display:flex; gap:10px; margin-top:16px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#ffffff12; border:1px solid #ffffff22; font-size:.8rem; color:var(--muted); }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .field { flex:1 1 260px; }
    .hint { color:var(--muted); font-size:.9rem; }

      /* === New API CSS === */
    .hidden { display: none !important; }

.toast {
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 9999;
  max-width: 360px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(20, 24, 32, .82);
  backdrop-filter: blur(14px);
  color: #fff;
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
.toast strong { display:block; margin-bottom: 4px; }
.toast .muted { opacity: .8; font-size: 13px; }
.toast.success { border-color: rgba(33, 188, 165, .35); }

.account-overview {
  margin-top: 18px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
}
.card {
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(20, 24, 32, .55);
  backdrop-filter: blur(10px);
  padding: 14px 14px 12px;
  color: #fff;
}
.card h3 {
  margin: 0 0 10px;
  font-size: 14px;
  letter-spacing: .02em;
  opacity: .92;
}
.kv { display:flex; justify-content: space-between; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,.06); }
.kv:last-child { border-bottom: none; }
.k { opacity:.75; font-size: 13px; }
.v { font-size: 13px; text-align: right; overflow-wrap: anywhere; }

.pill {
  display: inline-flex;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  font-size: 12px;
  opacity: .95;
}
.pill.good { border-color: rgba(33,188,165,.35); color: #a7fff1; }
.pill.warn { border-color: rgba(255, 190, 120, .35); color: #ffd7b0; }
  </style>
</head>
<body>
  <!-- Shimmer Loader (full-screen, hidden by default) -->
  <div id="page-loader" class="loader-shimmer" role="status" aria-live="polite" aria-hidden="true">
    <span class="sr-only">Loading…</span>
  </div>

  <div class="bg" aria-hidden="true"></div>
  <canvas id="bg-stars" aria-hidden="true"></canvas>

  <header>
    <div class="nav">
      <a class="brand" href="https://fortiviewholdings.com">
        <div class="logo" aria-hidden="true"></div>
        <strong style="color: var(--ink);">Fortiview</strong>
        <span style="color:var(--brand-600)">Holdings</span>
        <span class="site-label">PragOptics™ System Integration</span>
      </a>
      <nav aria-label="Primary">
        <ul>
          <li class="dropdown">
            <button class="link dropdown-toggle" onclick="toggleDropdown()">Services ▾</button>
            <ul id="servicesDropdown" class="dropdown-menu">
              <li><a href="/leadership">Leadership & Business Strategy</a></li>
              <li><a href="/operations">Project & Operations Management</a></li>
              <li><a href="/finance">Financial Coordination</a></li>
              <li><a href="/marketing">Marketing, Sales & Client Relations</a></li>
              <li><a href="/governance">Governance & Regulatory Support</a></li>
              <li><a href="/cx">Customer Experience Optimization</a></li>
              <li><a href="/partnerships">Networking & Partnerships</a></li>
              <li><a href="/industrial">Industrial Automation</a></li>
              <li><a href="/integration/">PragOptics™ System Integration</a></li>
              <li><a href="/YouthBusinessEducationSandbox/">Youth Entrepreneur Education</a></li>
            </ul>
          </li>
          <li><a class="link" href="/integration/terms">Terms & Conditions</a></li>
          <li><a class="cta" href="https://billing.stripe.com/p/login/4gM00beIf91O1Kzc3DdjO00">Manage Subscription</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- PragOptics Section -->
  <section id="integration" class="section">
    <div class="glass">
      <h2 style="margin-top:0; color:var(--muted)">PragOptics™<span style="color: var(--brand-600);"> System Integration</span></h2>
      <p style="color:var(--muted); font-size:1.05rem; line-height:1.6;">
        PragOptics™ is our framework for unifying your business systems into a single,
        transparent architecture. We connect your data, workflows, and customer touchpoints
        into dashboards that drive clarity and accountability.
      </p>
      <ul style="margin-top:16px; color:var(--ink); line-height:1.6; list-style:none; padding-left:0;">
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-integrate"></use></svg>
          Seamless integration of Microsoft 365, CRM, and POS systems</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-puzzle"></use></svg>
          Software as a Solution (SaaS), delivering ready‑to‑use cloud applications that streamline operations without infrastructure overhead</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-dashboard"></use></svg>
          Unified dashboards for finance, operations, and customer experience</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-energy"></use></svg>
          Automation pipelines (Power Automate, PowerShell, Python)</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone"></use></svg>
          iOS & Web App Development – high‑performance mobile experiences that connect your customers and operations</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-fingerprint"></use></svg>
          Identity-aware access control and compliance-ready logging</li>
        <li><svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-scale"></use></svg>
          Scalable architecture designed for growth and partnerships</li>
      </ul>

      <!-- Existing CTA Button (unchanged) -->
<div style="margin-top:28px;">
  <button
    id="packageSelectorBtn"
    class="cta-btn"
    onclick="openCtaBox()">
    Strategic Service Packages
  </button>

  <button
    id="usePragOpticsApiBtn"
    class="cta-btn"
    style="margin-left:12px"
    onclick="openAgreementModal(event)">
    PragOptics API Subscription
  </button>
</div>

<div id="accountOverview" class="account-overview hidden"></div>

      <!-- Hidden Container (existing) -->
      <div id="ctaBox" class="glass" style="display:none; margin-top:20px; padding:20px;">
        <h3 style="margin-top:0; color:var(--muted)">Choose <span style="color: var(--brand-600)">Your Tier</span></h3>
        <div id="tierOptions" style="display:flex; gap:16px; flex-wrap:wrap;">
          <div class="option-card" onclick="selectTier(this,'Email Essentials')">
            <strong style="color: var(--ink)">Email Essentials</strong>
            <p style="color:var(--muted); font-size:.9rem;">Branded email, SharePoint, backend support</p>
          </div>
          <div class="option-card" onclick="selectTier(this,'Productivity Suite')">
            <strong style="color: var(--ink)">Productivity Suite</strong>
            <p style="color:var(--muted); font-size:.9rem;">Everything in Essentials + Office apps, Teams, automation</p>
          </div>
          <div class="option-card" onclick="selectTier(this,'Automation Builder')">
            <strong style="color: var(--ink)">Automation Builder</strong>
            <p style="color:var(--muted); font-size:.9rem;">Everything in Productivity + Power Automate Premium & Power Apps Plan w/ Fortiview Cloud-Sharing</p>
          </div>
          <div class="option-card" onclick="selectTier(this,'Super User Suite')">
            <strong style="color: var(--ink)">Super User Suite</strong>
            <p style="color:var(--muted); font-size:.9rem;">Everything in Automation + MS Agents</p>
          </div>
        </div>
        <!-- Payment Terms -->
        <div id="planBox" style="display:none; margin-top:24px;">
          <h3 style="margin-top:0; color:var(--muted)">Select <span style="color: var(--brand-600)">Payment Plan</span></h3>
          <div id="planOptions" style="display:flex; gap:16px; flex-wrap:wrap;">
            <div class="option-card" onclick="selectPlan(this,'Monthly')"><strong style="color: var(--ink)">Monthly</strong></div>
            <div class="option-card" onclick="selectPlan(this,'Quarterly')"><strong style="color: var(--ink)">Quarterly</strong></div>
            <div class="option-card" onclick="selectPlan(this,'Annual')"><strong style="color: var(--ink)">Annual</strong></div>
          </div>
        </div>
        <!-- Confirmation -->
        <div id="summaryBox" style="display:none; margin-top:24px; color:var(--ink);">
          <h3 style="margin-top:0; color:var(--brand-600)">Your <span style="color: var(--muted)">Selection</span></h3>
          <p id="summaryText"></p>
          <button id="submitBtn" class="cta-btn" style="margin-top:16px; display:none;" onclick="showContactForm()">
            Submit Request
          </button>
        </div>
        <!-- Contact Form (existing) -->
        <div id="contactForm" style="display:none; margin-top:24px;">
          <h3 style="margin-top:0; color:var(--muted)">Please Provide <span style="color: var(--brand-600)">Contact Information</span></h3>
          <form onsubmit="handleFormSubmit(event)" autocomplete="on">
            <label>
              Name:<br>
              <input type="text" id="custName" name="name" autocomplete="name"
                required style="width:100%; padding:8px; margin:6px 0;">
            </label><br>
            <label>
              Business Name:<br>
              <input type="text" id="businessName" name="organization" autocomplete="organization"
                required style="width:100%; padding:8px; margin:6px 0;">
            </label><br>
            <label>
              Email:<br>
              <input type="email" id="custEmail" name="email" autocomplete="email"
                required style="width:100%; padding:8px; margin:6px 0;">
            </label><br>
            <label>
              Phone:<br>
              <input type="tel" id="custPhone" name="tel" autocomplete="tel"
                inputmode="numeric" maxlength="10"
                placeholder="Enter 10 digits"
                style="width:100%; padding:8px; margin:6px 0;"
                onblur="formatPhone(this)">
            </label><br>
            <label>
              State:<br>
              <select id="custState" name="address-level1" autocomplete="address-level1"
                required style="width:100%; padding:8px; margin:6px 0;">
                <option value="">Select a state</option>
                <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>
                <option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option>
                <option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
                <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>
                <option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option>
                <option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
                <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>
                <option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option>
                <option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option>
                <option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
              </select>
            </label><br>
            <label class="sms-consent">
              <input type="checkbox" id="smsConsent" name="smsConsent">
              <span class="sms-text">
                I consent to receive informational/transactional SMS messages & Phone Calls from Fortiview Holdings in regards to account notifications and one-time passcodes. Message frequency varies. Message and data rates may apply. Reply STOP to opt-out.
                <a href="/integration/terms#privacy" class="privacy-link" target="_self">See our Privacy Policy</a>.
              </span>
            </label><br>
            <button type="submit" class="cta-btn" style="margin-top:12px;" data-act="integration">Finalize Request</button>
          </form>
        </div>
      </div>

      <!-- NEW: Platform Subscription Wizard (appears after successful CIAM login) -->
      <div id="platformFlow" class="wizard" style="display:none;" aria-live="polite">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0; color:var(--brand-600)">PragOptics™ Platform Subscription</h3>
          <span class="badge" id="authBadge" title="Authentication status">Signed out</span>
        </div>
        <p class="hint" style="margin-top:6px;">Complete these steps to create your billing profile and activate your PragOptics™ subscription.</p>

        <!-- Step 1: Choose Role -->
        <div id="step1" class="step is-active">
          <h3>Step 1 — Choose Subscriber Type</h3>
          <div class="row">
            <label class="option-card" style="text-align:left;">
              <input type="radio" name="subType" value="user" style="margin-right:10px;"> <strong>User</strong>
              <div class="hint">Base: <strong>$7.50/user/month</strong> — includes 10,000 API calls, 1 GB storage, website deploy, domain check.</div>
            </label>
            <label class="option-card" style="text-align:left;">
              <input type="radio" name="subType" value="partner" style="margin-right:10px;"> <strong>Partner</strong>
              <div class="hint">Base: <strong>$49/month</strong> — Partner RG + storage, custom namespace, onboard users, set retail pricing.</div>
            </label>
          </div>
          <div class="controls">
            <button class="cta-btn" onclick="gotoStep2()" id="toStep2" disabled>Next</button>
          </div>
        </div>

        <!-- Step 2: Choose Add-ons (varies) -->
        <div id="step2" class="step">
          <h3>Step 2 — Select Plan & Add‑Ons</h3>
          <div class="row">
            <div class="field">
              <label class="hint"><strong>Plan cadence</strong></label><br/>
              <label><input type="radio" name="cadence" value="monthly" checked> Monthly</label>&nbsp;&nbsp;
              <label><input type="radio" name="cadence" value="annual"> Annual</label>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div class="field">
              <label class="hint"><strong>Add‑ons (optional)</strong></label>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoDomains"> Domains + Business Email ($7.50/user/month)</label>
              </div>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoStorage"> Additional Storage ($2.00 per 5GB/month)</label>
              </div>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoFlows"> Workflow Bundle ($3.00 per 10,000 executions)</label>
              </div>
              <div class="option-card" style="text-align:left;">
                <label><input type="checkbox" id="aoApi"> API Bundle ($5.00 per 50,000 calls)</label>
              </div>
            </div>
            <div class="field">
              <div class="option-card" style="text-align:left;">
                <strong>Pricing Summary</strong>
                <div id="priceSummary" class="hint">Select options to view an estimate.</div>
              </div>
              <div class="hint" style="margin-top:8px;">Actual billing is finalized in Stripe after identity is verified.</div>
            </div>
          </div>
          <div class="controls">
            <button class="cta-btn secondary" onclick="gotoStep1()">Back</button>
            <button class="cta-btn" onclick="gotoStep3()">Next</button>
          </div>
        </div>

        <!-- Step 3: Billing Profile (requires token) -->
        <div id="step3" class="step">
          <h3>Step 3 — Create Billing Profile</h3>
          <p class="hint">You are signed in. Complete contact details to create your Stripe billing profile.</p>
          <form onsubmit="handleBillingProfile(event)">
            <div class="row">
              <div class="field">
                <label>Name<br>
                  <input id="bpName" type="text" required style="width:100%; padding:8px; margin:6px 0;">
                </label>
              </div>
              <div class="field">
                <label>Email<br>
                  <input id="bpEmail" type="email" required style="width:100%; padding:8px; margin:6px 0;">
                </label>
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label>Phone<br>
                  <input id="bpPhone" type="tel" style="width:100%; padding:8px; margin:6px 0;" onblur="formatPhone(this)">
                </label>
              </div>
              <div class="field">
                <label>Organization (optional)<br>
                  <input id="bpOrg" type="text" style="width:100%; padding:8px; margin:6px 0;">
                </label>
              </div>
            </div>
            <div class="row">
             <div class="field">
              <label>Address Line 1<br>
              <input id="bpAddr1" type="text" required style="width:100%; padding:8px; margin:6px 0;">
             </label>
            </div>
            <div class="field">
              <label>Address Line 2 (optional)<br>
                <input id="bpAddr2" type="text" style="width:100%; padding:8px; margin:6px 0;">
              </label>
           </div>
          </div>

          <div class="row">
           <div class="field">
             <label>City<br>
               <input id="bpCity" type="text" required style="width:100%; padding:8px; margin:6px 0;">
              </label>
           </div>
           <div class="field">
              <label>Postal Code<br>
                <input id="bpPostal" type="text" required style="width:100%; padding:8px; margin:6px 0;">
             </label>
            </div>
          </div>

          <div class="row">
           <div class="field">
              <label>State<br>
                <select id="bpState" required style="width:100%; padding:8px; margin:6px 0;">
                <option value="">Select a state</option>
                <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>
                <option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option>
                <option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
                <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>
                <option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option>
                <option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
                <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>
                <option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option>
                <option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option>
                <option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
              </select>
              </label>
            </div>
          </div>

          <div class="row">
           <div class="field">
             <label>Country<br>
               <select id="bpCountry" required style="width:100%; padding:8px; margin:6px 0;">
                  <option value="US" selected>United States</option>
                  <option value="CA">Canada</option>
               </select>
             </label>
            </div>
          </div>
            <div class="controls">
              <button class="cta-btn secondary" type="button" onclick="gotoStep2()">Back</button>
              <button class="cta-btn" type="submit">Create Billing Profile</button>
            </div>

          </form>
        </div>
                                <!-- Step 4: Payment (Stripe Elements) -->
            <div id="step4" class="step">
             <h3>Step 4 — Payment</h3>
             <p class="hint">Secure payment powered by Stripe.</p>

             <div class="option-card" style="text-align:left;">
                <div id="payment-element"></div>
              </div>

             <div class="controls">
                <button class="cta-btn secondary" type="button" onclick="gotoStep3()">Back</button>
                <button class="cta-btn" type="button" id="payNowBtn">Pay & Activate</button>
              </div>

             <div id="payMsg" class="hint" style="margin-top:10px;"></div>
            </div>
      </div>

    </div>
  </section>

  <!-- Pricing Section (unchanged) -->
  <section id="pricing" class="section">
    <div class="glass">
      <h2 style="margin-top:0; color:var(--brand)">Strategic <span style="color: var(--muted)">Service Packages</span></h2>
      <p style="color:var(--ink); margin-bottom:24px;">
        Transparent pricing with scalable options. Every package includes a dedicated tenant,
        domain integration, and Fortiview-managed security.
      </p>
      <h3 style="margin-top:0; color:var(--muted)">One-Time Fee <span style="color: var(--brand-600)">$1500</span></h3>
            <p style="color:var(--ink); margin-bottom:24px;">
        This covers the initial setup and configuration of your PragOptics™ environment, including:
      </p>
      <ul>
        <li>Dedicated Microsoft 365 tenant creation</li>
        <li>Domain integration and DNS configuration</li>
        <li>Branded SharePoint environment</li>
        <li>Front-facing static website</li>
        <li>Identity and access control setup</li>
        <li>Initial user provisioning and license assignment</li>
        <li>Backend security enforcement and monitoring</li>
      </ul>
      <br>

      <h2 style="margin-top:0; color:var(--brand)">PragOptics™ <span style="color: var(--muted)">API Subscription</span></h2>
              <h3 style="margin-top:0; color:var(--muted)">One-Time Fee <span style="color: var(--brand-600)">WAIVED</span></h3>
            <p style="color:var(--ink); margin-bottom:24px;">
      Setup fee not included in PragOptics™ API subscripton; PragOptics™ API subscription is a self service product.
      </p>

      <h3 style="margin-top:0; color:var(--muted)">Subscription Tiers <span style="color: var(--brand-600)">(Per User)</span></h3>
      <p style="text-align: center; color: var(--fg-light); font-size: 0.9em; margin-bottom: 0.5em;">
        ⟳ Rotate your <svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone"></use></svg>for Mobile Friendly View
      </p>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Service / Feature</th>
              <th>Email Essentials</th>
              <th>Productivity Suite</th>
              <th>Automation Builder</th>
              <th>Super User Suite</th>
              <th>PragOptics™ API User</th>
              <th>PragOptics™ API Partner</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Initial Set-Up fee required</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="cross"></td><td class="cross"></td></tr>
            <tr><td>Branded email under your domain</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>Microsoft 365 license</td><td>Basic</td><td>Standard</td><td>Standard</td><td>Standard</td><td class="star"></td><td class="star"></td></tr>
            <tr><td>SharePoint access for document storage</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>DNS management (SPF, DKIM, DMARC)</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>Fortiview-managed updates & security</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Ongoing backend support</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Business training & onboarding</td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="check"></td></tr>
            <tr><td>Microsoft Teams collaboration</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>Microsoft Office apps (Word, Excel, Outlook, PowerPoint)</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>Advanced SharePoint features</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>Custom automation flows & app development</td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="check"></td><td class="cross"></td><td class="check"></td></tr>
            <tr><td>PowerApps Developer license</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>Power Automate Premium license</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="star"></td><td class="star"></td></tr>
            <tr><td>iOS App development & connected customer experience</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="cross"></td><td class="star"></td></tr>
            <tr><td>Fortiview workflow sharing & cloud development</td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="check"></td><td class="cross"></td><td class="check"></td></tr>
            <tr><td>MS Agent access (up to 25k credits/month)</td><td class="cross"></td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="cross"></td><td class="star"></td></tr>
            <tr><td>Additional agent usage billed separately</td><td class="cross"></td><td class="cross"></td><td class="cross"></td><td class="check"></td><td class="cross"></td><td class="check"></td></tr>
            <tr><td class="star">Optional feature included with API access for custom development and integration purposes.</td></tr>
          </tbody>
        </table>
      </div>

      <h3 style="margin-top:32px; color:var(--muted)">Pricing <span style="color: var(--brand-600);">(Per User)</span></h3>
      <p style="text-align: center; color: var(--fg-light); font-size: 0.9em; margin-bottom: 0.5em;">
        ⟳ Rotate your <svg class="icon"><use href="https://fortiviewholdings.com/icons/sprite.svg#icon-phone"></use></svg>for Mobile Friendly View
      </p>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Tier</th>
              <th>Monthly</th>
              <th>Quarterly <span style="color: var(--brand-600)">(5% off)</span></th>
              <th>Annual <span style="color: var(--brand-600)">(10% off)</span></th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Email Essentials</td><td>$10</td><td>$28.50</td><td>$108</td></tr>
            <tr><td>Productivity Suite</td><td>$20</td><td>$57.00</td><td>$216</td></tr>
            <tr><td>Automation Builder</td><td>$65</td><td>$185.25</td><td>$702</td></tr>
            <tr><td>Super User Suite</td><td>$350</td><td>$997.50</td><td>$3,780</td></tr>
            <tr><td>PragOptics™ API User</td><td>$7.50</td><td class="cross"></td><td>$81</td></tr>
            <tr><td>PragOptics™ API Partner</td><td>$49</td><td class="cross"></td><td>$529</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <footer>
    <p>© 2025 Fortiview Holdings LLC — Secure, scalable, and fully managed.</p>
  </footer>

  <!-- MODAL: Public Subscriber Agreement -->
  <div id="agreementMask" class="modal-overlay" aria-hidden="true"></div>
  <div id="agreementModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="agreementTitle" aria-hidden="true">
    <div class="modal-card" tabindex="-1">
      <div class="modal-head">
        <h3 id="agreementTitle" class="modal-title">PragOptics™ Subscriber & Partner Agreement <span class="badge">v1.0</span></h3>
        <button class="modal-close" type="button" aria-label="Close" onclick="closeAgreementModal()">✕</button>
      </div>
      <div class="modal-body">
        <div id="mdContainer" class="md-view" aria-live="polite">
          <p style="color:var(--muted)">Loading agreement…</p>
        </div>
      </div>
      <div class="modal-foot">
        <label class="ack">
          <input id="agreeChk" type="checkbox" />
          <span>I have read and agree to the PragOptics™ Subscriber & Partner Agreement (public). I acknowledge this acceptance may be recorded for compliance and onboarding.</span>
        </label>
        <div class="actions">
          <button type="button" class="cta-btn secondary" onclick="closeAgreementModal()">Cancel</button>
          <button id="agreeGoBtn" type="button" class="cta-btn primary" onclick="submitAgreementAck()" disabled>Continue</button>
        </div>
      </div>
    </div>
  </div>
<script>
  window.STRIPE_PUBLISHABLE_KEY = "pk_test_51SX4Ap1tawWN5DfLopaUfzzIYXmUhIxl8L91YRm5X1bp3X7A9Ugomzz65W1Y0HmnI7zesrfTFj0bnUWFyHcgq5lN00EQwSd4TO"; // or pk_test_xxx
</script>
<script src="https://js.stripe.com/v3"></script>
<script>

  // ===========================
  // Dropdown handling (UNCHANGED)
  // ===========================
  function toggleDropdown() {
    const menu = document.getElementById('servicesDropdown');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
  }
  document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.dropdown');
    if (dropdown && !dropdown.contains(e.target)) {
      const menu = document.getElementById('servicesDropdown');
      if (menu) menu.style.display = 'none';
    }
  });

  // ===========================
  // Global shimmer loader + viewport reset (UNCHANGED)
  // ===========================
  function resetViewportScale(options = { allowPinchAfter: true }) {
    let meta = document.querySelector('meta[name="viewport"]');
    if (!meta) {
      meta = document.createElement('meta');
      meta.name = 'viewport';
      document.head.appendChild(meta);
    }
    const base = 'width=device-width';
    meta.content = base + ', initial-scale=1.0001';
    requestAnimationFrame(() => {
      meta.content =
        base + ', initial-scale=1.0' +
        (options.allowPinchAfter ? ', user-scalable=yes' : ', maximum-scale=1.0');
    });
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
    setTimeout(() => { window.scrollTo(0, Math.max(0, window.pageYOffset + 0)); }, 0);
  }

  const htmlEl = document.documentElement;
  const loaderEl = document.getElementById('page-loader');

  function startLoading({ resetZoom = true } = {}) {
    if (resetZoom) resetViewportScale();
    htmlEl.classList.add('is-loading');
    if (loaderEl) loaderEl.setAttribute('aria-hidden', 'false');
  }
  function stopLoading() {
    htmlEl.classList.remove('is-loading');
    if (loaderEl) loaderEl.setAttribute('aria-hidden', 'true');
  }
  window.pageLoader = { start: startLoading, stop: stopLoading, resetViewportScale };

  // ===========================
  // Tier/Plan selection (UNCHANGED)
  // ===========================
  let selectedTier = null;
  let selectedPlan = null;

  function openCtaBox() {
    document.getElementById('ctaBox').style.display = 'block';
    try { document.getElementById('ctaBox').scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch {}
  }

  function selectTier(el, tier) {
    document.querySelectorAll('#tierOptions .option-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedTier = tier;
    document.getElementById('planBox').style.display = 'block';
    updateSummary();
  }

  function selectPlan(el, plan) {
    document.querySelectorAll('#planOptions .option-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedPlan = plan.toLowerCase();
    updateSummary();
  }

  function updateSummary() {
    if (selectedTier && selectedPlan) {
      document.getElementById('summaryBox').style.display = 'block';
      document.getElementById('summaryText').textContent =
        `You selected: ${selectedTier} with ${selectedPlan} billing.`;
      document.getElementById('submitBtn').style.display = 'inline-block';
    }
  }

  function showContactForm() { document.getElementById('contactForm').style.display = 'block'; }

  // ===========================
  // Phone formatting (UNCHANGED)
  // ===========================
  function formatPhone(input) {
    let digits = input.value.replace(/\D/g, '').substring(0, 10);
    if (digits.length === 10) {
      const area = digits.substring(0,3);
      const mid  = digits.substring(3,6);
      const last = digits.substring(6);
      input.value = `+1 (${area}) ${mid}-${last}`;
      input.dataset.raw = digits;
    } else {
      input.value = digits;
      input.dataset.raw = digits;
    }
  }

  // ===========================
  // Pricing configuration (UNCHANGED)
  // ===========================
  const INITIAL_SETUP_FEE = 1500;
  const PRICING_MATRIX = {
    "Email Essentials": { monthly: 10, quarterly: 28.50, annual: 108 },
    "Productivity Suite": { monthly: 20, quarterly: 57,   annual: 216 },
    "Automation Builder": { monthly: 65, quarterly: 185.25, annual: 702 },
    "Super User Suite": { monthly: 350, quarterly: 997.50, annual: 3780 }
  };

  // ===========================
  // OmniTok integration (UNCHANGED)
  // ===========================
  const API = {
    issueOmniTok: 'https://default6eda43f3fbf04e2b9978b543d9dd31.e3.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4be2293ea9ca4e418ac17059d7209cf1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=vGhxzQ1mnf06FenEffQzPjo1iP_OLyKLH-yzAkPGUjo'
  };

  async function getOmniTok(act) {
    let sid = sessionStorage.getItem('sid');
    if (!sid) { sid = crypto.randomUUID(); sessionStorage.setItem('sid', sid); }
    let body = (typeof act === 'string') ? { act, sid } : { sid, ...act };
    const res = await fetch(API.issueOmniTok, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Failed to get OmniTok config for ${body.act ?? act}`);
    const data = await res.json();
    return { ...data, sid };
  }

  // ===========================
  // Existing contact form handler (UNCHANGED)
  // ===========================
  async function handleFormSubmit(e) {
    e.preventDefault();
    const btn = e.submitter;
    const act = btn?.dataset.act ?? 'integration';
    const jobId = `IntReq-${crypto.randomUUID()}`;
    const perUserPrice = PRICING_MATRIX[selectedTier]?.[selectedPlan] ?? 0;

    const customerData = {
      jobId,
      name: document.getElementById('custName').value,
      business: document.getElementById('businessName').value,
      email: document.getElementById('custEmail').value,
      phoneRaw: document.getElementById('custPhone').dataset.raw ?? "",
      phoneFormatted: document.getElementById('custPhone').value,
      state: document.getElementById('custState').value,
      tier: selectedTier,
      plan: selectedPlan,
      setupFee: Number(INITIAL_SETUP_FEE),
      perUserPrice: Number(perUserPrice),
      smsConsent: document.getElementById('smsConsent').checked
    };

    btn.disabled = true;
    document.querySelectorAll('#ctaBox input, #ctaBox select, #ctaBox button').forEach(el => el.disabled = true);
    startLoading({ resetZoom: true });

    try {
      const omni = await getOmniTok(act);
      if (!omni.endpoint) throw new Error("Omnitok preflight did not return an endpoint");

      const response = await fetch(omni.endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-auth-token': omni.authToken,
          'x-omnitok': omni.OmniTok,
          'x-sid': omni.sid,
          'x-act': omni.act
        },
        body: JSON.stringify(customerData)
      });

      if (!response.ok) throw new Error("Backend rejected request");
      const result = await response.json();

      const ctaBox = document.getElementById('ctaBox');
      if (ctaBox) ctaBox.setAttribute('hidden', '');

      const selectBtn = document.querySelector('.cta-btn');
      if (selectBtn) {
        selectBtn.textContent = 'Package selected';
        selectBtn.classList.add('is-selected');
        selectBtn.disabled = true;
      }

      alert(
        `✅ Your request has been sent!\n\n` +
        `We've emailed a confirmation to: ${result.email ?? customerData.email}\n` +
        `If you don't see it, please check your spam folder and mark us as a trusted sender.\n\n` +
        `Tracking ID: ${jobId}`
      );
    } catch (err) {
      console.error("Submission error:", err);
      btn.disabled = false;
      document.querySelectorAll('#ctaBox input, #ctaBox select, #ctaBox button').forEach(el => el.disabled = false);
      alert("❌ Your request did not go through.\n\nPlease try again in a moment. If the problem persists, contact support.");
    } finally {
      stopLoading();
    }
  }


/* =====================================================================
   PragOptics API flow
   Markdown → Agree → Continue → CIAM → Callback → Ping → Wizard
   (EXACT Dev Console semantics)
   ===================================================================== */

const AGREEMENT_MD_URL = 'https://fortiviewholdings.com/docs/PragOptics-Subscriber-Agreement.md';
const PRAG_API_BASE    = 'https://api.pragoptics.com/api/v1';
const CIAM_LOGIN_INIT  = `${PRAG_API_BASE}/auth/login`;
const PING_URL         = `${PRAG_API_BASE}/ping`;
// ---- Billing endpoints (matches your Azure Functions routes) ----
const BILLING_PROFILE_URL  = `${PRAG_API_BASE}/billing/profile`;          // POST 
const CHECKOUT_SESSION_URL = `${PRAG_API_BASE}/billing/checkout-session`; // POST 

function getStoredTokens() {
  try { return JSON.parse(sessionStorage.getItem("pragoptics_tokens") || "null"); }
  catch { return null; }
}

async function fetchJson(url, options = {}) {
  const res = await fetch(url, options);
  const text = await res.text();

  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

  if (!res.ok) {
    const msg = data?.error || data?.raw || `${res.status} ${res.statusText}`;
    const err = new Error(msg);
    err.status = res.status;
    err.data = data;
    throw err;
  }
  return data;
}

function catalogMapFromPing(ping) {
  const arr = Array.isArray(ping?.productCatalog) ? ping.productCatalog : [];
  const map = new Map();
  for (const p of arr) map.set(p.lookupKey, p);
  return map;
}

function centsToDollars(amountStr) {
  const n = Number(amountStr || 0);
  return n / 100;
}

// UI-only intent object (backend remains authoritative) 
function buildRequestedSubscription({ subType, cadence, addons }) {
  return { subType, cadence, addons: subType === "user" ? { ...addons } : {} };
}

// Mirrors backend lookupKey conventions so summary matches what checkout-session will resolve 
function lookupKeysFromSelection({ subType, cadence, addons }) {
  const suffix = cadence === "annual" ? "annual" : "monthly";
  const baseKey = subType === "partner"
    ? `po.partner.premium.${suffix}`
    : `po.user.base.${suffix}`;

  const keys = [baseKey];
  if (subType === "user") {
    if (addons.domains) keys.push(`po.addon.domains.${suffix}`);
    if (addons.storage) keys.push(`po.addon.storage5gb.${suffix}`);
    if (addons.flows)   keys.push(`po.addon.flows10k.${suffix}`);
    if (addons.api)     keys.push(`po.addon.api50k.${suffix}`);
  }
  return keys;
}

/* ===========================
   Modal DOM
   =========================== */
const $modal = document.getElementById('agreementModal');
const $mask  = document.getElementById('agreementMask');
const $md    = document.getElementById('mdContainer');
const $agree = document.getElementById('agreeChk');
const $go    = document.getElementById('agreeGoBtn');

let modalFocusTrap = null;
let openerBtn = null;

/* ===========================
   Minimal Markdown renderer
   =========================== */
function mdToHtml(md) {
  const esc = s => s.replace(/[&<>]/g, c =>
    ({ '&':'&amp;', '<':'&lt;', '>':'&gt;' }[c])
  );

  md = md.replace(/\r\n?/g, '\n');

  // Horizontal rules
  md = md.replace(/^\s*(?:-{3,}|\*{3,})\s*$/gm, '<hr>');

  // Code fences
  md = md.replace(/```([\s\S]*?)```/g, (_,code)=>
    `<pre><code>${esc(code)}</code></pre>`
  );

  // Inline code
  md = md.replace(/`([^`]+)`/g, (_,c)=>`<code>${esc(c)}</code>`);

  // Headings
  md = md.replace(/^######\s?(.*)$/gm,'<h6>$1</h6>')
         .replace(/^#####\s?(.*)$/gm,'<h5>$1</h5>')
         .replace(/^####\s?(.*)$/gm,'<h4>$1</h4>')
         .replace(/^###\s?(.*)$/gm,'<h3>$1</h3>')
         .replace(/^##\s?(.*)$/gm,'<h2>$1</h2>')
         .replace(/^#\s?(.*)$/gm,'<h1>$1</h1>');

  // Bold / Italic
  md = md.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
         .replace(/\*([^*]+)\*/g,'<em>$1</em>');

  // ✅ GFM tables
  md = md.replace(
    /(^\|.+\|\s*\n\|(?:\s*:?-+:?\s*\|)+\s*\n(?:\|.*\|\s*\n)+)/gm,
    block => {
      const lines = block.trim().split('\n');
      const header = lines[0].slice(1,-1).split('|').map(c=>c.trim());
      const body = lines.slice(2).map(row =>
        row.slice(1,-1).split('|').map(c=>c.trim())
      );

      const thead = `<thead><tr>${
        header.map(h=>`<th>${h}</th>`).join('')
      }</tr></thead>`;

      const tbody = `<tbody>${
        body.map(r=>`<tr>${
          r.map(c=>`<td>${c}</td>`).join('')
        }</tr>`).join('')
      }</tbody>`;

      return `<table>${thead}${tbody}</table>`;
    }
  );

  // ✅ Protect tables before paragraph wrapping
  const TABLE_PLACEHOLDER = '§§TABLE_BLOCK§§';
  const tables = [];

  md = md.replace(/<table[\s\S]*?<\/table>/g, match => {
    tables.push(match);
    return TABLE_PLACEHOLDER;
  });

  // Paragraphs
  md = md.replace(
    /^(?!<h\d|<ul|<pre|<p|<table|<hr|<\/|\s*$)(.+)$/gm,
    '<p>$1</p>'
  );

  // ✅ Restore tables
  md = md.replace(new RegExp(TABLE_PLACEHOLDER, 'g'), () => tables.shift());

  return md;
}

/* ===========================
   Modal helpers
   =========================== */
function trapFocus(scope) {
  const nodes = [...scope.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])')]
    .filter(el => !el.disabled && el.offsetParent !== null);
  if (!nodes.length) return;
  const first = nodes[0], last = nodes[nodes.length - 1];
  modalFocusTrap = e => {
    if (e.key !== 'Tab') return;
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  };
  scope.addEventListener('keydown', modalFocusTrap);
}
function releaseFocus() {
  if (modalFocusTrap) $modal.removeEventListener('keydown', modalFocusTrap);
  modalFocusTrap = null;
}

function openAgreementModal(ev) {
  openerBtn = ev?.currentTarget || document.activeElement;
  $md.innerHTML = '<p style="color:var(--muted)">Loading agreement…</p>';
  $agree.checked = false;
  $go.disabled = true;

  $mask.classList.add('is-open');
  $modal.classList.add('is-open');

  fetch(AGREEMENT_MD_URL, { cache: 'no-store' })
    .then(r => r.text())
    .then(t => $md.innerHTML = mdToHtml(t))
    .finally(() => trapFocus($modal));
}

function closeAgreementModal() {
  releaseFocus();
  $mask.classList.remove('is-open');
  $modal.classList.remove('is-open');
  openerBtn?.focus();
}



function toast({ title, message, tone = "success", duration = 4000 }) {
  // Remove any existing toast to avoid stacking
  document.querySelectorAll('.toast').forEach(t => t.remove());

  const el = document.createElement('div');
  el.className = `toast ${tone}`;
  el.innerHTML = `
    <strong>${title}</strong>
    <div class="muted">${message}</div>
  `;
  document.body.appendChild(el);

  setTimeout(() => el.remove(), duration);
}

function showLoginToast(user) {
  const email = user?.email || "your account";
  toast({
    title: "Signed in",
    message: `Authenticated as ${email}.`,
    tone: "success",
    duration: 4200
  });
}

function renderAccountOverview(ping) {
  const el = document.getElementById('accountOverview');
  if (!el) return;

  const user = ping?.user || {};
  const deployment = ping?.deployment || {};
  const resources = Array.isArray(ping?.operatorResources) ? ping.operatorResources : [];

  const statusPill = (() => {
    const s = (user.status || "").toUpperCase();
    if (s === "ACTIVE") return `<span class="pill good">ACTIVE</span>`;
    if (s) return `<span class="pill warn">${s}</span>`;
    return `<span class="pill warn">UNKNOWN</span>`;
  })();

  const tierPill = (() => {
    const t = (user.tier || "").toUpperCase();
    if (t === "PAID") return `<span class="pill good">PAID</span>`;
    if (t) return `<span class="pill warn">${t}</span>`;
    return `<span class="pill warn">UNSET</span>`;
  })();

  // Compact resources list (descriptor only)
  const resourceList = resources
    .map(r => r?.descriptor)
    .filter(Boolean)
    .map(d => `<div class="kv"><div class="k">•</div><div class="v" style="text-align:left">${d}</div></div>`)
    .join('') || `<div class="muted">No operator resources returned.</div>`;

  el.innerHTML = `
    <div class="card">
      <h3>Account</h3>
      <div class="kv"><div class="k">Email</div><div class="v">${user.email || "—"}</div></div>
      <div class="kv"><div class="k">Role</div><div class="v">${user.role || "—"}</div></div>
      <div class="kv"><div class="k">Tier</div><div class="v">${tierPill}</div></div>
      <div class="kv"><div class="k">Status</div><div class="v">${statusPill}</div></div>
      <div class="kv"><div class="k">Billing Profile</div><div class="v">${user.billingProfileId || "—"}</div></div>
      <div class="kv"><div class="k">Environment</div><div class="v">${user.environmentId || "—"}</div></div>
    </div>

    <div class="card">
      <h3>Deployment</h3>
      <div class="kv"><div class="k">Service</div><div class="v">${ping?.service || "—"}</div></div>
      <div class="kv"><div class="k">Lane</div><div class="v">${deployment.lane || "—"}</div></div>
      <div class="kv"><div class="k">Build</div><div class="v">${deployment.build || "—"}</div></div>
      <div class="kv"><div class="k">Timestamp</div><div class="v">${ping?.timestamp || "—"}</div></div>
    </div>

    <div class="card">
      <h3>Operator Resources</h3>
      ${resourceList}
    </div>
  `;

  el.classList.remove('hidden');
}

/* ===========================
   Agree checkbox
   =========================== */
$agree.addEventListener('change', () => {
  $go.disabled = !$agree.checked;
});
$mask.addEventListener('click', closeAgreementModal);
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && $modal.classList.contains('is-open')) closeAgreementModal();
});

/* ===========================
   DEV CONSOLE LOGIN FLOW
   =========================== */
let pragopticsToken = null;

/* Helper: robustly extract authResult even if CIAM appends a second '?' */
function extractAuthResultFromLocation() {
  // normal case
  let params = new URLSearchParams(location.search);
  let encoded = params.get('authResult');
  if (encoded) return encoded;

  // broken case: ?post=subscribe?authResult=...
  const post = params.get('post');
  if (post && post.includes('authResult=')) {
    // post looks like "subscribe?authResult=%7B...%7D"
    return post.split('authResult=')[1] || null;
  }

  // alternative broken case: raw search contains "?authResult=" after another "?"
  const idx = location.search.indexOf('authResult=');
  if (idx >= 0) return location.search.slice(idx + 'authResult='.length);

  return null;
}

/* EXACT Dev Console login-init, but with CLEAN returnUrl to avoid double '?' */
async function submitAgreementAck() {
  if (!$agree.checked) return;

  // ✅ FIX: returnUrl MUST NOT contain ?post=subscribe
  // Let CIAM append ?authResult=... safely.
  const returnUrl = encodeURIComponent(`${location.origin}${location.pathname}`);

  const res = await fetch(`${CIAM_LOGIN_INIT}?returnUrl=${returnUrl}`);
  const data = await res.json();

  if (!data?.authorizeUrl) {
    alert("Unable to start login.");
    return;
  }

  closeAgreementModal();
  window.location = data.authorizeUrl;
}
window.submitAgreementAck = submitAgreementAck;

/* ===========================
   CALLBACK (EXACT order: token -> ping -> wizard)
   =========================== */
async function handlePragOpticsCallback() {
  const encoded = extractAuthResultFromLocation();
  if (!encoded) return;

  let authResult;
  try {
    authResult = JSON.parse(decodeURIComponent(encoded));
  } catch {
    alert("Login failed: invalid callback payload.");
    return;
  }

  if (!authResult.success) {
    alert(`Login failed: ${authResult.errorDescription || authResult.error}`);
    return;
  }

  // 1️⃣ Store token
  const tokens = authResult.tokens;
  pragopticsToken = tokens.access_token;
  sessionStorage.setItem("pragoptics_tokens", JSON.stringify(tokens));

  // 2️⃣ Clean URL (authResult removed)
  window.history.replaceState({}, document.title, location.pathname + "?post=subscribe");

  // 3️⃣ Call /ping (authoritative user state)
  const pingRes = await fetch(PING_URL, {
    headers: { Authorization: `Bearer ${pragopticsToken}` }
  });
  const ping = await pingRes.json();
  sessionStorage.setItem("pragoptics_ping", JSON.stringify(ping));

  // 4️⃣ Centralized UI decision (single source of truth)
  handlePostLoginUI(ping);
}

window.addEventListener("load", handlePragOpticsCallback);


// Hide entry buttons after login (both CTAs)
function hideEntryButtons() {
  document.getElementById('packageSelectorBtn')?.classList.add('hidden');
  document.getElementById('usePragOpticsApiBtn')?.classList.add('hidden');
}

// Post-login handler: decides billed-user view vs wizard
function handlePostLoginUI(ping) {
  const user = ping?.user || {};

  // Always hide CTAs once we have a real token/ping
  hideEntryButtons();

  // ✅ Case A: Billing exists → toast + account overview (no wizard)
  if (user.billingProfileId) {
    showLoginToast(user);
    renderAccountOverview(ping);
    
    // Ensure wizard is not shown
    document.getElementById('platformFlow')?.classList.add('hidden');
    return;
  }

  // ✅ Case B: No billing profile → wizard only (no CTAs)
  initPostLoginWizard(pragopticsToken, ping);
}

  // ===========================
  // Post-login: show Platform Wizard, prefill fields, compute pricing (existing)
  // ===========================
  const PLATFORM_PRICING = {
    userBase: 7.50,
    partnerPremium: 49.00,
    addons: { domainsEmail: 7.50, storage5gb: 2.00, flows10k: 3.00, api50k: 5.00 }
  };

  let selectedType = null;

  function decodeJwtPayload(tok) {
    try {
      const parts = tok.split('.');
      if (parts.length < 2) return {};
      const b64 = parts[1].replace(/-/g, '+').replace(/_/g, '/');
      const pad = b64 + '==='.slice((b64.length + 3) % 4);
      return JSON.parse(atob(pad));
    } catch { return {}; }
  }

  function initPostLoginWizard(accessToken) {
    const badge = document.getElementById('authBadge');
    if (badge) { badge.textContent = "Signed in"; badge.style.color = '#21bca5'; }

    const claims = decodeJwtPayload(accessToken || "");
    const bpEmail = document.getElementById('bpEmail');
    const bpName = document.getElementById('bpName');
    if (bpEmail) bpEmail.value = claims.email || '';
    if (bpName) bpName.value  = claims.name  || '';

    const flow = document.getElementById('platformFlow');
    if (flow) flow.style.display = 'block';

    document.querySelectorAll('input[name="subType"]').forEach(r => {
      r.addEventListener('change', () => {
        selectedType = r.value;
        const toStep2 = document.getElementById('toStep2');
        if (toStep2) toStep2.disabled = !selectedType;
        updatePriceSummary();
      });
    });
    document.querySelectorAll('input[name="cadence"]').forEach(r => r.addEventListener('change', updatePriceSummary));
    ['aoDomains','aoStorage','aoFlows','aoApi'].forEach(id => document.getElementById(id)?.addEventListener('change', updatePriceSummary));

    updatePriceSummary();
    try { flow?.scrollIntoView({ behavior: 'smooth' }); } catch {}
  }

  function gotoStep1() { document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active')); document.getElementById('step1')?.classList.add('is-active'); }
  function gotoStep2() { if (!selectedType) return; document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active')); document.getElementById('step2')?.classList.add('is-active'); updatePriceSummary(); }
  function gotoStep3() { document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active')); document.getElementById('step3')?.classList.add('is-active'); }

function updatePriceSummary() {
  const cadence = (document.querySelector('input[name="cadence"]:checked')?.value) || 'monthly';
  const addons = {
    domains: !!document.getElementById('aoDomains')?.checked,
    storage: !!document.getElementById('aoStorage')?.checked,
    flows:   !!document.getElementById('aoFlows')?.checked,
    api:     !!document.getElementById('aoApi')?.checked
  };
  const subType = selectedType || null;

  const summary = document.getElementById('priceSummary');
  if (!summary) return;

  if (!subType) {
    summary.innerHTML = `Select options to view an estimate.`;
    return;
  }

  const ping = (() => { try { return JSON.parse(sessionStorage.getItem("pragoptics_ping")||"null"); } catch { return null; }})();
  const catalog = catalogMapFromPing(ping);

  const keys = lookupKeysFromSelection({ subType, cadence, addons });
  let total = 0;
  const lines = [];

  for (const k of keys) {
    const row = catalog.get(k);
    if (!row) { lines.push(`• ${k}: (missing)`); continue; }
    const dollars = centsToDollars(row.amount);
    total += dollars;
    lines.push(`• ${k}: $${dollars.toFixed(2)}/${row.interval === "year" ? "yr" : "mo"}`);
  }

  summary.innerHTML = `
    <div><strong>${subType.toUpperCase()}</strong> — cadence: <strong>${cadence}</strong></div>
    <div style="margin-top:6px;">${lines.join("<br>")}</div>
    <div style="margin-top:8px;"><strong>Estimated total:</strong> $${total.toFixed(2)}${subType==="user" ? " per user" : ""} / ${cadence==="annual" ? "yr" : "mo"}</div>
    <div class="hint" style="margin-top:6px;">Finalized in Stripe. Backend remains authoritative.</div>
  `;
}

  // ===========================
  // Billing Profile submit (keeps OmniTok; can now use token + ping routing)
  // ===========================
  let stripe = null;
let elements = null;

function gotoStep4() {
  document.querySelectorAll('.wizard .step').forEach(s => s.classList.remove('is-active'));
  document.getElementById('step4')?.classList.add('is-active');
}

async function handleBillingProfile(e) {
  e.preventDefault();

  const stored = getStoredTokens?.();
  const accessToken = stored?.access_token || pragopticsToken;
  if (!accessToken) { alert('Please sign in first.'); return; }

  const cadence = (document.querySelector('input[name="cadence"]:checked')?.value) || 'monthly';
  const addons = {
    domains: !!document.getElementById('aoDomains')?.checked,
    storage: !!document.getElementById('aoStorage')?.checked,
    flows:   !!document.getElementById('aoFlows')?.checked,
    api:     !!document.getElementById('aoApi')?.checked
  };

  const subType = selectedType || "user";
  const requestedSubscription = buildRequestedSubscription({ subType, cadence, addons });

  // REQUIRED by /v1/billing/profile 
  const profilePayload = {
    customerName: document.getElementById('bpName')?.value?.trim(),
    primaryEmail: document.getElementById('bpEmail')?.value?.trim(),
    phone:        document.getElementById('bpPhone')?.value?.trim() || "",
    addressLine1: document.getElementById('bpAddr1')?.value?.trim(),
    addressLine2: document.getElementById('bpAddr2')?.value?.trim() || "",
    city:         document.getElementById('bpCity')?.value?.trim(),
    state:        (document.getElementById('bpState')?.value || "").trim(), 
    postalCode:   document.getElementById('bpPostal')?.value?.trim(),
    country:      document.getElementById('bpCountry')?.value?.trim(),
    requestedSubscription
  };

  try {
    startLoading({ resetZoom: true });

    // 1) Create/merge BillingProfile 
    const bpResp = await fetchJson(BILLING_PROFILE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${accessToken}` },
      body: JSON.stringify(profilePayload)
    });

    // 2) Create checkout session (Elements subscription) -> client_secret 
    const csResp = await fetchJson(CHECKOUT_SESSION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": `Bearer ${accessToken}` },
      body: JSON.stringify({})
    });

    const clientSecret = csResp?.paymentIntentClientSecret;
    if (!clientSecret) throw new Error("Missing Stripe client secret.");

    // 3) Mount Stripe Elements
    const PUBLISHABLE_KEY = window.STRIPE_PUBLISHABLE_KEY || ""; // set this globally or inline
    if (!PUBLISHABLE_KEY) throw new Error("Stripe publishable key not configured.");

    stripe = Stripe(PUBLISHABLE_KEY);
    elements = stripe.elements({ clientSecret });

        document.getElementById("payment-element").innerHTML = "";
        const paymentEl = elements.create("payment");
        paymentEl.mount("#payment-element");

    // 4) Wire Pay button
    document.getElementById("payNowBtn").onclick = async () => {
      document.getElementById("payMsg").textContent = "Confirming payment…";
      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: { return_url: `${location.origin}${location.pathname}?post=subscribe` }
      });
      if (error) document.getElementById("payMsg").textContent = error.message || "Payment error.";
    };

    gotoStep4();

  } catch (err) {
    console.error(err);
    alert(`❌ ${err.message || "Billing setup failed."}`);
  } finally {
    stopLoading();
  }
}

  // ===========================
  // Starfield background (UNCHANGED)
  // ===========================
  function initStarField() {
    const canvas = document.getElementById('bg-stars');
    const ctx = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);

    const stars = Array.from({ length: 120 }, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 1.6 + 0.4,
      a: Math.random()
    }));
    let frame = 0, reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function animate() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for (const s of stars) {
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${s.a})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
        if(!reduce){
          s.a = 0.25 + Math.abs(Math.sin((frame/60) + s.x*0.001 + s.y*0.001)) * 0.75;
        }
      }
      frame++;
      requestAnimationFrame(animate);
    }
    animate();
  }
  window.addEventListener('load', initStarField);
</script>
</body>
</html>
